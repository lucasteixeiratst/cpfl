<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerar files.json para Mapa CPFL</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            background-color: #f4f4f4;
        }
        h1 {
            font-size: 24px;
            color: #333;
        }
        button {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
        }
        button:hover {
            background-color: #357ae8;
        }
        #log {
            background-color: white;
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            margin-bottom: 10px;
            font-family: monospace;
            font-size: 14px;
        }
        #jsonOutput {
            width: 100%;
            height: 200px;
            font-family: monospace;
            font-size: 14px;
            background-color: #fff;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        #copyJson {
            background-color: #4CAF50;
        }
        #copyJson:hover {
            background-color: #45a049;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/@tmcw/togeojson@5.8.1/dist/togeojson.umd.js"></script>
</head>
<body>
    <h1>Gerar files.json para Mapa CPFL</h1>
    <button id="generateBtn">Gerar files.json</button>
    <div id="log">Aguardando início do processamento...</div>
    <textarea id="jsonOutput" readonly placeholder="O arquivo files.json aparecerá aqui após a geração."></textarea>
    <button id="copyJson" style="display: none;">Copiar JSON</button>

    <script>
        const generateBtn = document.getElementById('generateBtn');
        const logDiv = document.getElementById('log');
        const jsonOutput = document.getElementById('jsonOutput');
        const copyJsonBtn = document.getElementById('copyJson');

        // Lista de arquivos KMZ
        const kmzFiles = [
            "AGUAS DE LINDOIA.kmz", "AGUDOS.kmz", "ALTINOPOLIS.kmz", "AMERICANA.kmz", "AMPARO.kmz",
            "ARACATUBA.kmz", "ARARAQUARA.kmz", "BARIRI.kmz", "BARRA BONITA.kmz", "BARRETOS.kmz",
            "BATATAIS.kmz", "BAURU.kmz", "BEBEDOURO.kmz", "BIRIGUI.kmz", "BOA ESPERANCA DO SUL.kmz",
            "BOTUCATU.kmz", "BRAUNA.kmz", "BROTAS.kmz", "CAFELANDIA.kmz", "CAJOBI.kmz",
            "CAJURU.kmz", "CAMPINAS BARAO GERALDO-1.kmz", "CAMPINAS CAMPO GRANDE-1.kmz",
            "CAMPINAS CENTRO-1.kmz", "CAMPINAS SOUZAS-1.kmz", "CAMPINAS TREVO-1.kmz", "CAPIVARI.kmz",
            "CONGONHAS.kmz", "COSMOPOLIS.kmz", "CRAVINHOS.kmz", "DESCALVADO.kmz", "DOIS CORREGOS.kmz",
            "DOURADO.kmz", "DUARTINA.kmz", "ESPIRITO SANTO DO PINHAL.kmz", "FRANCA.kmz", "GARCA.kmz",
            "GAVIAO PEIXOTO.kmz", "GETULINA.kmz", "GUAIRA.kmz", "GUANABARA.kmz", "GUARARAPES.kmz",
            "GUARIBA.kmz", "HIPODROMO.kmz", "HORTOLANDIA.kmz", "IACANGA.kmz", "IBIRA.kmz",
            "IBITINGA.kmz", "IGARAPAVA.kmz", "IPUA.kmz", "ITAPIRA.kmz", "ITAPOLIS.kmz", "ITATIBA.kmz",
            "ITATINGA.kmz", "ITUVERAVA.kmz", "JABOTICABAL.kmz", "JARDINOPOLIS.kmz", "JAU.kmz",
            "JOSE BONIFACIO.kmz", "LENCOIS PAULISTA.kmz", "LINS.kmz", "MARILIA.kmz", "MATAO.kmz",
            "METROPOLITANA.kmz", "MIGUELOPOLIS.kmz", "MIRASSOL.kmz", "MONTE ALTO.kmz",
            "MONTE APRAZIVEL.kmz", "MONTE MOR.kmz", "MORRO AGUDO.kmz", "MORRO DO CIPO.kmz",
            "NOVA GRANADA.kmz", "OCAUCU.kmz", "OLIMPIA.kmz", "ORLANDIA.kmz", "PARAISO.kmz",
            "PARDINHO.kmz", "PAULINIA.kmz", "PEDERNEIRAS.kmz", "PEDREGULHO.kmz", "PENAPOLIS.kmz",
            "PIACATU.kmz", "PIRACICABA SANTA CECILIA.kmz", "PIRACICABA SANTA TEREZINHA.kmz",
            "PIRACICABA.kmz", "PIRAJUI - EA.kmz", "PIRANGI.kmz", "PITANGUEIRAS.kmz", "POMPEIA.kmz",
            "PRESIDENTE ALVES.kmz", "PROMISSAO.kmz", "RESTINGA.kmz", "RIBEIRAO PRETO NORTE.kmz",
            "RIBEIRAO PRETO SUL.kmz", "RINCAO.kmz", "SANTA ADELIA.kmz", "SANTA BARBARA DOESTE.kmz",
            "SANTA ROSA DE VITERBO.kmz", "SANTO ANTONIO ARACANGUA.kmz", "SAO CARLOS.kmz",
            "SAO JOAQUIM DA BARRA.kmz", "SAO JOSE RIO PRETO.kmz", "SAO MANUEL.kmz", "SAO PEDRO.kmz",
            "SAO SIMAO.kmz", "SERRA NEGRA.kmz", "SERRANA.kmz", "SERTAOZINHO.kmz", "SOCORRO.kmz",
            "SUMARE.kmz", "TANABI.kmz", "TAQUARITINGA.kmz", "UIRAPURU.kmz", "VALINHOS.kmz",
            "VALPARAISO.kmz", "VIRADOURO.kmz"
        ];

        // Base URL dos KMZ
        const baseUrl = "https://lucasteixeiratst.github.io/cpfl/kmz/";

        // Função para logar mensagens
        function logMessage(message) {
            logDiv.innerHTML += message + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Função para processar um KMZ
        async function processKMZ(fileName) {
            try {
                const url = `${baseUrl}${fileName}`;
                logMessage(`Processando ${fileName}...`);
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Erro ao baixar: ${response.status}`);

                const arrayBuffer = await response.arrayBuffer();
                const zip = await JSZip.loadAsync(arrayBuffer);
                const kmlFile = zip.file(/\.kml$/i)[0];
                if (!kmlFile) throw new Error(`Arquivo KML não encontrado`);

                const kmlContent = await kmlFile.async('string');
                const kmlDoc = new DOMParser().parseFromString(kmlContent, 'text/xml');
                const geojson = toGeoJSON.kml(kmlDoc);

                // Extrair marcadores (pontos)
                const markers = [];
                geojson.features.forEach(feature => {
                    if (feature.geometry.type === 'Point') {
                        const props = feature.properties || {};
                        const name = props.name || '';
                        const alimentador = props.Alimentador || '';
                        if (name || alimentador) {
                            markers.push({
                                name: name,
                                alimentador: alimentador,
                                coordinates: feature.geometry.coordinates // [lon, lat]
                            });
                        }
                    }
                });

                logMessage(`Concluído: ${fileName} (${markers.length} marcadores)`);
                return {
                    name: fileName,
                    url: url,
                    markers: markers
                };
            } catch (error) {
                logMessage(`Erro em ${fileName}: ${error.message}`);
                return {
                    name: fileName,
                    url: `${baseUrl}${fileName}`,
                    markers: [],
                    error: error.message
                };
            }
        }

        // Função principal para gerar files.json
        async function generateFilesJson() {
            generateBtn.disabled = true;
            logDiv.innerHTML = '';
            logMessage('Iniciando processamento dos 116 arquivos KMZ...');

            const results = [];
            for (const fileName of kmzFiles) {
                const result = await processKMZ(fileName);
                results.push(result);
            }

            // Gerar o files.json
            const filesJson = { files: results };
            const jsonString = JSON.stringify(filesJson, null, 2);

            // Exibir no textarea
            jsonOutput.value = jsonString;
            copyJsonBtn.style.display = 'inline-block';

            // Criar download
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'files.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            logMessage('files.json gerado e baixado!');
            generateBtn.disabled = false;
        }

        // Copiar JSON para a área de transferência
        copyJsonBtn.addEventListener('click', () => {
            jsonOutput.select();
            document.execCommand('copy');
            logMessage('JSON copiado para a área de transferência!');
        });

        // Iniciar geração ao clicar no botão
        generateBtn.addEventListener('click', generateFilesJson);
    </script>
</body>
</html>
