<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Índice KMZ Minimalista</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }
        .progress-container {
            margin: 20px 0;
        }
        progress {
            width: 100%;
            height: 20px;
            border-radius: 4px;
        }
        .status {
            margin-top: 10px;
            font-weight: bold;
            min-height: 20px;
        }
        button {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #3367d6;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Índice Minimalista de KMZ</h1>
        <p>Gera um índice otimizado contendo apenas coordenadas e arquivo de origem.</p>
        
        <div class="progress-container">
            <progress id="loadingProgress" value="0" max="100"></progress>
            <div class="status" id="statusText">Aguardando início</div>
        </div>
        
        <button id="btnStart">Iniciar Processamento</button>
        <button id="btnDownload" disabled>Baixar Índice (.gz)</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xmldom/0.6.0/xmldom.min.js"></script>
    <script src="https://unpkg.com/@tmcw/togeojson/dist/togeojson.umd.js"></script>

    <script>
        const KMZ_FILES = [
            // Sua lista de 116 arquivos aqui
            'ARARAQUARA.kmz', 'BAURU.kmz', /* ... */, 'VIRADOURO.kmz'
        ];

        const state = {
            index: [], // Formato: [filenameIndex, lat, lng][]
            filenames: [],
            processed: 0
        };

        // Elementos UI
        const btnStart = document.getElementById('btnStart');
        const btnDownload = document.getElementById('btnDownload');
        const progress = document.getElementById('loadingProgress');
        const status = document.getElementById('statusText');

        btnStart.addEventListener('click', processFiles);
        btnDownload.addEventListener('click', downloadIndex);

        async function processFiles() {
            btnStart.disabled = true;
            state.index = [];
            state.filenames = KMZ_FILES.map(f => f.replace('.kmz', ''));
            state.processed = 0;
            
            for (let i = 0; i < KMZ_FILES.length; i++) {
                const file = KMZ_FILES[i];
                status.textContent = `Processando ${i+1}/${KMZ_FILES.length}: ${file}`;
                progress.value = (i / KMZ_FILES.length) * 100;
                
                try {
                    const markers = await extractMarkers(file);
                    markers.forEach(marker => {
                        // Armazena como [índice_arquivo, lat, lng]
                        state.index.push([i, marker[1], marker[0]]);
                    });
                    state.processed++;
                } catch (error) {
                    console.error(`Erro em ${file}:`, error);
                }
                
                // Pausa para não bloquear a UI
                await new Promise(resolve => setTimeout(resolve, 0));
            }
            
            status.textContent = `Pronto! ${state.index.length} marcadores de ${state.processed} arquivos`;
            progress.value = 100;
            btnDownload.disabled = false;
        }

        async function extractMarkers(filename) {
            const response = await fetch(filename);
            const buffer = await response.arrayBuffer();
            const zip = await JSZip.loadAsync(buffer);
            const kmlFile = zip.file(/\.kml$/i)[0];
            const kmlText = await kmlFile.async('text');
            const kmlDoc = new DOMParser().parseFromString(kmlText, 'text/xml');
            const geojson = toGeoJSON.kml(kmlDoc);
            
            return geojson.features
                .filter(f => f.geometry?.type === 'Point')
                .map(f => f.geometry.coordinates); // [lng, lat]
        }

        function downloadIndex() {
            const data = {
                v: 2, // Versão do formato
                f: state.filenames, // Lista de nomes de arquivos
                i: state.index // Índice de coordenadas
            };
            
            // Converte para JSON e compacta
            const json = JSON.stringify(data);
            const compressed = pako.gzip(json);
            
            // Cria download
            const blob = new Blob([compressed], {type: 'application/gzip'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `indice_kmz_${new Date().toISOString().slice(0,10)}.gz`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            status.textContent = `Download gerado (${Math.round(compressed.length/1024)} KB)`;
        }
    </script>
</body>
</html>
