<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cadastro de Serviços</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/uuid@9.0.1/dist/umd/uuidv4.min.js"></script>
  <style>
    :root {
      --ms-blue: #0078d7;
      --ms-blue-dark: #106ebe;
      --ms-green: #107c10;
      --ms-green-dark: #0e6b0e;
      --ms-gray-light: #f3f2f1;
      --ms-gray-border: #edebe9;
    }
    
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background-color: #f8f9fa;
    }
    
    .fade-in { animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    select[multiple] { scrollbar-width: thin; }
    select[multiple]::-webkit-scrollbar { width: 6px; }
    select[multiple]::-webkit-scrollbar-thumb { background: var(--ms-blue); border-radius: 4px; }
    
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .status-green { background-color: var(--ms-green); }
    .status-red { background-color: #d13438; }
    
    .ms-card {
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      background-color: white;
      border: 1px solid var(--ms-gray-border);
    }
    
    .ms-button {
      border-radius: 4px;
      font-weight: 600;
      transition: all 0.2s;
      padding: 8px 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      border: none;
    }
    
    .ms-button-primary {
      background-color: var(--ms-blue);
      color: white;
    }
    
    .ms-button-primary:hover {
      background-color: var(--ms-blue-dark);
    }
    
    .ms-button-success {
      background-color: var(--ms-green);
      color: white;
    }
    
    .ms-button-success:hover {
      background-color: var(--ms-green-dark);
    }
    
    .ms-button-neutral {
      background-color: #f4f4f4;
      color: #333;
    }
    
    .ms-button-neutral:hover {
      background-color: #eaeaea;
    }
    
    .ms-form-label {
      font-weight: 600;
      color: #323130;
      margin-bottom: 6px;
      display: block;
    }
    
    .ms-form-input {
      border: 1px solid var(--ms-gray-border);
      border-radius: 4px;
      padding: 10px 12px;
      width: 100%;
      font-size: 15px;
      transition: border-color 0.2s;
    }
    
    .ms-form-input:focus {
      outline: 2px solid var(--ms-blue);
      outline-offset: -1px;
      border-color: transparent;
    }
    
    .ms-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .ms-table th {
      background-color: var(--ms-gray-light);
      font-weight: 600;
      color: #323130;
      text-align: left;
      padding: 12px 16px;
      border-bottom: 1px solid var(--ms-gray-border);
    }
    
    .ms-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--ms-gray-border);
    }
    
    .ms-status-bar {
      background-color: var(--ms-blue);
      color: white;
      padding: 10px 0;
    }
    
    .details-panel {
      position: fixed;
      top: 0;
      right: -500px;
      width: 480px;
      height: 100vh;
      background: white;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
      z-index: 1000;
      transition: right 0.3s ease;
      overflow-y: auto;
      padding: 20px;
    }
    
    .details-panel.open {
      right: 0;
    }
    
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      display: none;
    }
    
    .overlay.show {
      display: block;
    }
    
    .tests-section {
      background-color: #f8f8f8;
      border-top: 1px solid #eee;
      padding: 15px;
      margin-top: 30px;
    }
    
    .tests-container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    .test-button {
      background: #e5e5e5;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .test-button:hover {
      background: #d5d5d5;
    }
    
    .toggle-details {
      background: none;
      border: none;
      color: var(--ms-blue);
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 5px 0;
    }
    
    .service-tag {
      background-color: #e1f0ff;
      color: var(--ms-blue);
      border-radius: 4px;
      padding: 3px 8px;
      font-size: 12px;
      display: inline-block;
      margin: 2px;
    }
    
    .editing-mode {
      box-shadow: 0 0 0 2px var(--ms-blue);
    }
    
    .edit-notice {
      background-color: #e1f0ff;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col">
  <div class="overlay" id="overlay"></div>
  
  <div class="details-panel" id="detailsPanel">
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-semibold">Detalhes do Serviço</h3>
      <button id="closeDetails" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
    </div>
    <div id="serviceDetails" class="space-y-4"></div>
  </div>

  <header class="bg-white shadow-sm">
    <div class="container max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center">
        <div class="bg-gray-200 border-2 border-dashed rounded-xl w-16 h-16" />
        <div class="ml-4">
          <h1 class="text-2xl font-semibold text-gray-800">Cadastro de Serviços</h1>
          <p class="text-gray-600">Sistema de gerenciamento de serviços de poda</p>
        </div>
      </div>
      <div class="flex items-center">
        <div id="autoStatus" class="status-dot status-green mr-2"></div>
        <span id="statusMessage">Conectado</span>
      </div>
    </div>
  </header>

  <div class="container max-w-6xl mx-auto p-4 flex-grow">
    <div id="editNotice" class="edit-notice hidden">
      <i class="fas fa-edit text-blue-600"></i>
      <div>
        <strong>Modo de Edição</strong>
        <p>Você está editando um serviço existente. Atualize as informações e clique em "Atualizar Serviço".</p>
      </div>
    </div>
    
    <div class="ms-card p-6 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="ms-card bg-gray-50 p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Geolocalização</h3>
          <div class="flex flex-col space-y-3">
            <button onclick="app.geolocation.getAddress()" class="ms-button ms-button-primary">
              <i class="fas fa-home"></i> Preencher Endereço Automático
            </button>
            <button onclick="app.geolocation.getCoordinates()" class="ms-button ms-button-primary">
              <i class="fas fa-map-marker-alt"></i> Obter Coordenadas
            </button>
          </div>
          <div class="grid grid-cols-2 gap-3 mt-4">
            <div>
              <label class="ms-form-label">Latitude</label>
              <input type="text" id="latitude" class="ms-form-input" readonly>
            </div>
            <div>
              <label class="ms-form-label">Longitude</label>
              <input type="text" id="longitude" class="ms-form-input" readonly>
            </div>
          </div>
        </div>

        <div class="p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Dados do Serviço</h3>
          <div class="grid grid-cols-2 gap-4">
            <div class="flex flex-col">
              <label for="equipe" class="ms-form-label">Equipe</label>
              <input type="text" id="equipe" class="ms-form-input">
            </div>
            <div class="flex flex-col">
              <label for="matricula" class="ms-form-label">Matrícula</label>
              <input type="text" id="matricula" class="ms-form-input">
            </div>
            <div class="flex flex-col">
              <label for="ea" class="ms-form-label">EA</label>
              <input type="text" id="ea" class="ms-form-input">
            </div>
            <div class="flex flex-col">
              <label for="data" class="ms-form-label">Data</label>
              <input type="date" id="data" class="ms-form-input">
            </div>
          </div>
        </div>
      </div>

      <h3 class="text-xl font-semibold text-gray-800 mb-4">Registro de Serviços</h3>
      <form id="formulario" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <div class="flex flex-col">
          <label for="endereco" class="ms-form-label">Endereço</label>
          <input type="text" id="endereco" class="ms-form-input" required>
        </div>
        <div class="flex flex-col">
          <label for="numero" class="ms-form-label">Número</label>
          <input type="text" id="numero" class="ms-form-input">
        </div>
        <div class="flex flex-col">
          <label for="bairro" class="ms-form-label">Bairro</label>
          <input type="text" id="bairro" class="ms-form-input">
        </div>
        
        <div class="flex flex-col">
          <label for="tronco" class="ms-form-label">Tronco</label>
          <select id="tronco" class="ms-form-input">
            <option value="">Selecione...</option>
            <option value="TRONCO">TRONCO</option>
            <option value="RAMAL">RAMAL</option>
          </select>
        </div>
        <div class="flex flex-col">
          <label for="chave" class="ms-form-label">Chave</label>
          <input type="text" id="chave" class="ms-form-input">
        </div>
        <div class="flex flex-col">
          <label for="qtd" class="ms-form-label">Quantidade</label>
          <input type="number" id="qtd" class="ms-form-input" min="0" step="1">
        </div>
        
        <div class="flex flex-col">
          <label for="alimentador" class="ms-form-label">Alimentador</label>
          <input type="text" id="alimentador" class="ms-form-input">
        </div>
        
        <div class="flex flex-col col-span-1 sm:col-span-2 lg:col-span-3">
          <label for="obs" class="ms-form-label">Observação</label>
          <textarea id="obs" class="ms-form-input h-24"></textarea>
        </div>
        
        <div class="flex flex-col col-span-1 sm:col-span-2 lg:col-span-3">
          <label for="servico" class="ms-form-label">Serviço (Selecione um ou mais)</label>
          <select id="servico" multiple size="6" class="ms-form-input w-full" required>
            <option value="PC">Poda primária completa - PC</option>
            <option value="PS">Poda secundária completa - PS</option>
            <option value="PP">Poda primária parcial - PP</option>
            <option value="SP">Poda secundária parcial - SP</option>
            <option value="U">Cruzeta urgente troca em 15 dias - U</option>
            <option value="CV">Corte de cerca viva - CV</option>
            <option value="A">Cruzeta alta para 90 dias - A</option>
          </select>
        </div>
      </form>

      <div class="flex flex-wrap gap-3 mb-6 justify-center">
        <button id="btnSalvar" onclick="app.form.save(event)" class="ms-button ms-button-success">
          <i class="fas fa-save"></i> Salvar Serviço
        </button>
        <button onclick="app.form.clear()" class="ms-button ms-button-neutral">
          <i class="fas fa-broom"></i> Limpar Formulário
        </button>
        <button onclick="app.details.togglePanel()" class="ms-button ms-button-primary">
          <i class="fas fa-list"></i> Ver Serviços
        </button>
      </div>

      <div id="status" class="mb-6 p-3 rounded text-white hidden" aria-live="polite"></div>
    </div>

    <div class="mt-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-gray-800">Serviços Registrados</h3>
        <button class="toggle-details" onclick="app.details.togglePanel()">
          <i class="fas fa-expand"></i> Ver detalhes completos
        </button>
      </div>
      <div class="overflow-x-auto ms-card">
        <table id="tabela" class="ms-table w-full">
          <thead>
            <tr>
              <th>Endereço</th>
              <th>Bairro</th>
              <th>Qtd</th>
              <th>Data</th>
              <th>Equipe</th>
              <th>Serviços</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
    
    <div class="tests-section">
      <div class="tests-container">
        <div class="flex justify-between items-center">
          <h4 class="text-sm font-medium text-gray-600">Testes de Conexão</h4>
          <div class="flex gap-2">
            <button onclick="app.tests.testBackend()" class="test-button">
              <i class="fas fa-link mr-1"></i> Backend
            </button>
            <button onclick="app.tests.testDatabase()" class="test-button">
              <i class="fas fa-database mr-1"></i> Banco
            </button>
            <button onclick="app.tests.testServices()" class="test-button">
              <i class="fas fa-list-check mr-1"></i> Serviços
            </button>
          </div>
        </div>
        <div id="statusTestes" class="mt-2 p-2 rounded text-sm hidden" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <footer class="ms-status-bar mt-auto">
    <div class="container max-w-6xl mx-auto px-4 py-2 flex items-center justify-between">
      <div class="text-sm">
        Sistema de Cadastro de Serviços v1.2 | © 2023
      </div>
      <div class="flex items-center">
        <div id="autoStatus" class="status-dot mr-2"></div>
        <span id="statusMessage">Conectando...</span>
      </div>
    </div>
  </footer>

  <script>
    const app = {
      BASE_URL: 'https://fonseca.onrender.com',
      
      form: {
        editId: null,
        
        save: function(event) {
          event.preventDefault();
          const btnSalvar = document.getElementById('btnSalvar');
          btnSalvar.disabled = true;
          btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
          
          const endereco = document.getElementById('endereco').value.trim();
          const servicosSelecionados = Array.from(document.getElementById('servico').selectedOptions).map(opt => opt.value);
          const qtd = document.getElementById('qtd').value;
          const data = document.getElementById('data').value;
          
          if (!endereco) {
            app.utils.showStatus('Endereço é obrigatório.', 'error');
            btnSalvar.disabled = false;
            btnSalvar.innerHTML = this.editId ? '<i class="fas fa-sync-alt"></i> Atualizar Serviço' : '<i class="fas fa-save"></i> Salvar Serviço';
            return;
          }
          if (!servicosSelecionados.length) {
            app.utils.showStatus('Selecione pelo menos um serviço.', 'error');
            btnSalvar.disabled = false;
            btnSalvar.innerHTML = this.editId ? '<i class="fas fa-sync-alt"></i> Atualizar Serviço' : '<i class="fas fa-save"></i> Salvar Serviço';
            return;
          }
          if (qtd && qtd < 0) {
            app.utils.showStatus('Quantidade deve ser um número positivo.', 'error');
            btnSalvar.disabled = false;
            btnSalvar.innerHTML = this.editId ? '<i class="fas fa-sync-alt"></i> Atualizar Serviço' : '<i class="fas fa-save"></i> Salvar Serviço';
            return;
          }
          if (data && new Date(data) > new Date()) {
            app.utils.showStatus('Data não pode ser futura.', 'error');
            btnSalvar.disabled = false;
            btnSalvar.innerHTML = this.editId ? '<i class="fas fa-sync-alt"></i> Atualizar Serviço' : '<i class="fas fa-save"></i> Salvar Serviço';
            return;
          }
          
          const item = {
            id: this.editId || uuidv4(),
            ...app.utils.sanitizeForm(),
            servicos: servicosSelecionados.join(', ')
          };
          
          app.cache.saveFields();
          app.api.saveService(item).finally(() => {
            btnSalvar.disabled = false;
            btnSalvar.innerHTML = this.editId ? '<i class="fas fa-sync-alt"></i> Atualizar Serviço' : '<i class="fas fa-save"></i> Salvar Serviço';
          });
        },
        
        clear: function() {
          document.getElementById('formulario').reset();
          this.editId = null;
          document.getElementById('btnSalvar').innerHTML = '<i class="fas fa-save"></i> Salvar Serviço';
          document.getElementById('editNotice').classList.add('hidden');
          document.body.classList.remove('editing-mode');
          document.getElementById('endereco').focus();
          app.cache.loadFields();
        },
        
        edit: function(id) {
          const item = app.data.services.find(i => i.id == id); // Use == para lidar com string/number
          if (!item) {
            app.utils.showStatus('Serviço não encontrado.', 'error');
            return;
          }
          
          this.editId = id.toString(); // Garantir que editId seja string
          
          // Limpar formulário antes de preencher
          document.getElementById('formulario').reset();
          
          // Preencher todos os campos
          const fields = [
            'endereco', 'numero', 'bairro', 'tronco', 'chave',
            'qtd', 'alimentador', 'obs', 'data', 'equipe', 'matricula', 'ea',
            'latitude', 'longitude'
          ];
          
          fields.forEach(key => {
            const element = document.getElementById(key);
            if (element) {
              element.value = app.utils.sanitizeInput(item[key] || '');
            }
          });
          
          // Preencher serviços (select múltiplo)
          const servicoElement = document.getElementById('servico');
          const servicosArray = item.servicos ? item.servicos.split(', ').map(s => s.trim()) : [];
          Array.from(servicoElement.options).forEach(option => {
            option.selected = servicosArray.includes(option.value);
          });
          
          // Atualizar interface
          document.getElementById('btnSalvar').innerHTML = '<i class="fas fa-sync-alt"></i> Atualizar Serviço';
          document.getElementById('editNotice').classList.remove('hidden');
          document.body.classList.add('editing-mode');
          document.getElementById('endereco').focus();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      },
      
      cache: {
        fields: ['equipe', 'matricula', 'ea'],
        
        saveFields: function() {
          this.fields.forEach(field => {
            const value = document.getElementById(field).value.trim();
            if (value) {
              localStorage.setItem(field, value);
            }
          });
        },
        
        loadFields: function() {
          this.fields.forEach(field => {
            const savedValue = localStorage.getItem(field);
            if (savedValue) {
              document.getElementById(field).value = savedValue;
            }
          });
        }
      },
      
      geolocation: {
        lastCall: 0,
        debounceDelay: 3000,
        
        getCoordinates: function() {
          if (Date.now() - this.lastCall < this.debounceDelay) {
            app.utils.showStatus('Aguarde antes de tentar novamente.', 'error');
            return;
          }
          this.lastCall = Date.now();
          
          if (!navigator.geolocation) {
            app.utils.showStatus('Geolocalização não suportada.', 'error');
            return;
          }
          
          app.utils.showStatus('Obtendo coordenadas...', 'success');
          
          navigator.geolocation.getCurrentPosition(
            pos => {
              document.getElementById('latitude').value = pos.coords.latitude.toFixed(6);
              document.getElementById('longitude').value = pos.coords.longitude.toFixed(6);
              app.utils.showStatus('Coordenadas obtidas com sucesso!', 'success');
            },
            err => app.utils.showStatus('Erro ao obter localização: ' + err.message, 'error')
          );
        },
        
        getAddress: function() {
          if (Date.now() - this.lastCall < this.debounceDelay) {
            app.utils.showStatus('Aguarde antes de tentar novamente.', 'error');
            return;
          }
          this.lastCall = Date.now();
          
          if (!navigator.onLine) {
            app.utils.showStatus('Sem conexão. Insira manualmente.', 'error');
            return;
          }
          
          if (!navigator.geolocation) {
            app.utils.showStatus('Geolocalização não suportada. Insira manualmente.', 'error');
            return;
          }
          
          app.utils.showStatus('Buscando endereço...', 'success');
          
          navigator.geolocation.getCurrentPosition(
            pos => {
              const lat = pos.coords.latitude;
              const lon = pos.coords.longitude;
              const cacheKey = `address_${lat}_${lon}`;
              const cachedAddress = localStorage.getItem(cacheKey);
              
              if (cachedAddress) {
                const address = JSON.parse(cachedAddress);
                document.getElementById('endereco').value = address.road || '';
                document.getElementById('numero').value = address.housenumber || '';
                document.getElementById('bairro').value = address.bairro || '';
                document.getElementById('latitude').value = lat.toFixed(6);
                document.getElementById('longitude').value = lon.toFixed(6);
                app.utils.showStatus('Endereço obtido do cache!', 'success');
                return;
              }
              
              const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
              
              fetch(url, { headers: { 'User-Agent': 'CadastroServicos/1.0' } })
                .then(res => {
                  if (res.status === 429) {
                    throw new Error('Limite de requisições excedido. Tente novamente mais tarde.');
                  }
                  if (!res.ok) throw new Error(`Erro HTTP: ${res.status}`);
                  return res.json();
                })
                .then(data => {
                  const address = data.address || {};
                  const bairro = address.suburb || address.neighbourhood || address.quarter || address.city_district || '';
                  document.getElementById('endereco').value = address.road || address.street || '';
                  document.getElementById('numero').value = address.housenumber || '';
                  document.getElementById('bairro').value = bairro;
                  document.getElementById('latitude').value = lat.toFixed(6);
                  document.getElementById('longitude').value = lon.toFixed(6);
                  
                  localStorage.setItem(cacheKey, JSON.stringify({
                    road: address.road || address.street || '',
                    housenumber: address.housenumber || '',
                    bairro
                  }));
                  
                  app.utils.showStatus('Endereço obtido com sucesso!', 'success');
                })
                .catch(err => {
                  app.utils.showStatus('Erro ao buscar endereço: ' + err.message, 'error');
                  document.getElementById('endereco').focus();
                });
            },
            err => {
              app.utils.showStatus('Erro ao obter localização: ' + err.message, 'error');
              document.getElementById('endereco').focus();
            }
          );
        }
      },
      
      details: {
        togglePanel: function() {
          const panel = document.getElementById('detailsPanel');
          const overlay = document.getElementById('overlay');
          
          if (panel.classList.contains('open')) {
            panel.classList.remove('open');
            overlay.classList.remove('show');
          } else {
            panel.classList.add('open');
            overlay.classList.add('show');
            app.data.renderFullDetails();
          }
        },
        
        closePanel: function() {
          document.getElementById('detailsPanel').classList.remove('open');
          document.getElementById('overlay').classList.remove('show');
        }
      },
      
      tests: {
        testBackend: async function() {
          try {
            app.utils.showStatus('Testando conexão com backend...', 'success', 'statusTestes');
            const response = await fetch(app.BASE_URL);
            if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
            const data = await response.json();
            app.utils.showStatus('✅ Backend conectado com sucesso! Mensagem: ' + data.message, 'success', 'statusTestes');
          } catch (err) {
            app.utils.showStatus('❌ Erro ao conectar ao backend: ' + err.message, 'error', 'statusTestes');
          }
        },
        
        testDatabase: async function() {
          try {
            app.utils.showStatus('Testando conexão com banco de dados...', 'success', 'statusTestes');
            const response = await fetch(`${app.BASE_URL}/test-db`);
            if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
            const data = await response.json();
            app.utils.showStatus('✅ Conexão com o banco bem-sucedida! Horário: ' + data.time, 'success', 'statusTestes');
          } catch (err) {
            app.utils.showStatus('❌ Erro ao conectar ao banco: ' + err.message, 'error', 'statusTestes');
          }
        },
        
        testServices: async function() {
          try {
            app.utils.showStatus('Testando endpoint de serviços...', 'success', 'statusTestes');
            const response = await fetch(`${app.BASE_URL}/servicos`);
            if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
            const data = await response.json();
            app.utils.showStatus(`✅ Endpoint /servicos funcionando! ${data.length} registros encontrados.`, 'success', 'statusTestes');
          } catch (err) {
            app.utils.showStatus('❌ Erro ao acessar /servicos: ' + err.message, 'error', 'statusTestes');
          }
        }
      },
      
      api: {
        async saveService(item) {
          try {
            const method = app.form.editId ? 'PUT' : 'POST';
            const url = app.form.editId ? `${app.BASE_URL}/servicos/${app.form.editId}` : `${app.BASE_URL}/servicos`;
            
            app.utils.showStatus('Salvando serviço...', 'success');
            
            const response = await fetch(url, {
              method,
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(item)
            });
            
            if (!response.ok) {
              let errorMessage = `Erro HTTP: ${response.status}`;
              try {
                const errorData = await response.json();
                errorMessage = errorData.error || errorMessage;
              } catch {
                // Backend não retornou JSON válido
              }
              throw new Error(errorMessage);
            }
            
            await app.data.load();
            app.form.clear();
            app.utils.showStatus(app.form.editId ? '✅ Registro atualizado com sucesso!' : '✅ Registro salvo com sucesso!', 'success');
            app.form.editId = null;
          } catch (err) {
            app.utils.showStatus(`❌ Erro ao ${app.form.editId ? 'atualizar' : 'salvar'}: ${err.message}`, 'error');
          }
        },
        
        async deleteService(id) {
          if (!confirm('Deseja realmente excluir este serviço?')) return;
          try {
            app.utils.showStatus('Excluindo serviço...', 'success');
            const response = await fetch(`${app.BASE_URL}/servicos/${id}`, { method: 'DELETE' });
            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(errorData.error || `Erro HTTP: ${response.status}`);
            }
            await app.data.load();
            app.utils.showStatus('✅ Serviço excluído com sucesso!', 'success');
          } catch (err) {
            app.utils.showStatus(`❌ Erro ao excluir: ${err.message}`, 'error');
          }
        },
        
        async autoTestConnection() {
          try {
            const response = await fetch(`${app.BASE_URL}/test-db`);
            if (response.ok) {
              const data = await response.json();
              document.getElementById('autoStatus').className = 'status-dot status-green';
              document.getElementById('statusMessage').textContent = `Conectado - ${data.time}`;
            }
          } catch {
            document.getElementById('autoStatus').className = 'status-dot status-red';
            document.getElementById('statusMessage').textContent = 'Conexão falhou';
          }
        }
      },
      
      data: {
        services: [],
        
        async load() {
          try {
            const response = await fetch(`${app.BASE_URL}/servicos`);
            if (!response.ok) {
              throw new Error(`Erro HTTP: ${response.status}`);
            }
            this.services = await response.json();
          } catch (err) {
            this.services = [];
            app.utils.showStatus(`❌ Erro ao carregar dados: ${err.message}`, 'error');
          }
          this.renderTable();
        },
        
        renderTable() {
          const tbody = document.querySelector('#tabela tbody');
          tbody.innerHTML = '';
          
          if (this.services.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="p-3 text-center">Nenhum serviço registrado</td></tr>';
            return;
          }
          
          this.services.forEach(item => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50 transition-colors';
            
            const servicesHtml = item.servicos 
              ? item.servicos.split(', ').map(s => 
                  `<span class="service-tag">${app.utils.sanitizeInput(s)}</span>`).join('')
              : '';
            
            tr.innerHTML = `
              <td class="p-3">${app.utils.sanitizeInput(item.endereco || '')} ${app.utils.sanitizeInput(item.numero || '')}</td>
              <td class="p-3">${app.utils.sanitizeInput(item.bairro || '')}</td>
              <td class="p-3">${app.utils.sanitizeInput(item.qtd || '')}</td>
              <td class="p-3">${app.utils.sanitizeInput(item.data || '')}</td>
              <td class="p-3">${app.utils.sanitizeInput(item.equipe || '')}</td>
              <td class="p-3">${servicesHtml}</td>
              <td class="p-3 flex gap-2">
                <button onclick="app.form.edit('${item.id}')" class="text-blue-600 hover:text-blue-800" aria-label="Editar">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="app.api.deleteService('${item.id}')" class="text-red-600 hover:text-red-800" aria-label="Excluir">
                  <i class="fas fa-trash"></i>
                </button>
                <button onclick="app.details.showDetails('${item.id}')" class="text-green-600 hover:text-green-800" aria-label="Detalhes">
                  <i class="fas fa-eye"></i>
                </button>
              </td>
            `;
            
            tbody.appendChild(tr);
          });
        },
        
        renderFullDetails() {
          const container = document.getElementById('serviceDetails');
          container.innerHTML = '';
          
          if (this.services.length === 0) {
            container.innerHTML = '<p class="text-center py-8">Nenhum serviço registrado</p>';
            return;
          }
          
          this.services.forEach(item => {
            const card = document.createElement('div');
            card.className = 'ms-card p-4';
            
            const servicesHtml = item.servicos 
              ? item.servicos.split(', ').map(s => 
                  `<span class="service-tag">${app.utils.sanitizeInput(s)}</span>`).join('')
              : '';
            
            card.innerHTML = `
              <div class="flex justify-between">
                <h4 class="font-semibold text-lg">${app.utils.sanitizeInput(item.endereco)} ${app.utils.sanitizeInput(item.numero)}</h4>
                <div class="flex gap-2">
                  <button onclick="app.form.edit('${item.id}'); app.details.closePanel();" class="text-blue-600 hover:text-blue-800" title="Editar">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="app.api.deleteService('${item.id}')" class="text-red-600 hover:text-red-800" title="Excluir">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              <div class="mt-3 grid grid-cols-2 gap-3 text-sm">
                <div><strong>Bairro:</strong> ${app.utils.sanitizeInput(item.bairro || '-')}</div>
                <div><strong>Tronco:</strong> ${app.utils.sanitizeInput(item.tronco || '-')}</div>
                <div><strong>Chave:</strong> ${app.utils.sanitizeInput(item.chave || '-')}</div>
                <div><strong>Quantidade:</strong> ${app.utils.sanitizeInput(item.qtd || '-')}</div>
                <div><strong>Alimentador:</strong> ${app.utils.sanitizeInput(item.alimentador || '-')}</div>
                <div><strong>Data:</strong> ${app.utils.sanitizeInput(item.data || '-')}</div>
                <div><strong>Equipe:</strong> ${app.utils.sanitizeInput(item.equipe || '-')}</div>
                <div><strong>Matrícula:</strong> ${app.utils.sanitizeInput(item.matricula || '-')}</div>
                <div><strong>EA:</strong> ${app.utils.sanitizeInput(item.ea || '-')}</div>
              </div>
              <div class="mt-3">
                <strong>Observação:</strong>
                <p class="mt-1 bg-gray-50 p-2 rounded">${app.utils.sanitizeInput(item.obs || '-')}</p>
              </div>
              <div class="mt-3">
                <strong>Serviços:</strong>
                <div class="mt-1 flex flex-wrap gap-1">${servicesHtml}</div>
              </div>
              <div class="mt-3 text-xs text-gray-500">
                <strong>Coordenadas:</strong> ${app.utils.sanitizeInput(item.latitude || '-')}, ${app.utils.sanitizeInput(item.longitude || '-')}
              </div>
            `;
            
            container.appendChild(card);
          });
        },
        
        showDetails: function(id) {
          const item = this.services.find(i => i.id == id);
          if (!item) {
            app.utils.showStatus('Serviço não encontrado.', 'error');
            return;
          }
          
          const container = document.getElementById('serviceDetails');
          
          const servicesHtml = item.servicos 
            ? item.servicos.split(', ').map(s => 
                `<span class="service-tag">${app.utils.sanitizeInput(s)}</span>`).join('')
            : '';
          
          container.innerHTML = `
            <div class="ms-card p-4">
              <div class="flex justify-between">
                <h4 class="font-semibold text-lg">${app.utils.sanitizeInput(item.endereco)} ${app.utils.sanitizeInput(item.numero)}</h4>
                <div class="flex gap-2">
                  <button onclick="app.form.edit('${item.id}'); app.details.closePanel();" class="text-blue-600 hover:text-blue-800" title="Editar">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="app.api.deleteService('${item.id}')" class="text-red-600 hover:text-red-800" title="Excluir">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </div>
              <div class="mt-3 grid grid-cols-2 gap-3">
                <div><strong>Bairro:</strong> ${app.utils.sanitizeInput(item.bairro || '-')}</div>
                <div><strong>Tronco:</strong> ${app.utils.sanitizeInput(item.tronco || '-')}</div>
                <div><strong>Chave:</strong> ${app.utils.sanitizeInput(item.chave || '-')}</div>
                <div><strong>Quantidade:</strong> ${app.utils.sanitizeInput(item.qtd || '-')}</div>
                <div><strong>Alimentador:</strong> ${app.utils.sanitizeInput(item.alimentador || '-')}</div>
                <div><strong>Data:</strong> ${app.utils.sanitizeInput(item.data || '-')}</div>
                <div><strong>Equipe:</strong> ${app.utils.sanitizeInput(item.equipe || '-')}</div>
                <div><strong>Matrícula:</strong> ${app.utils.sanitizeInput(item.matricula || '-')}</div>
                <div><strong>EA:</strong> ${app.utils.sanitizeInput(item.ea || '-')}</div>
              </div>
              <div class="mt-3">
                <strong>Observação:</strong>
                <p class="mt-1 bg-gray-50 p-2 rounded">${app.utils.sanitizeInput(item.obs || '-')}</p>
              </div>
              <div class="mt-3">
                <strong>Serviços:</strong>
                <div class="mt-1 flex flex-wrap gap-1">${servicesHtml}</div>
              </div>
              <div class="mt-3 text-sm text-gray-500">
                <strong>Coordenadas:</strong> ${app.utils.sanitizeInput(item.latitude || '-')}, ${app.utils.sanitizeInput(item.longitude || '-')}
              </div>
            </div>
          `;
          
          app.details.togglePanel();
        }
      },
      
      utils: {
        sanitizeInput(input) {
          if (typeof input !== 'string') return input;
          return DOMPurify.sanitize(input);
        },
        
        sanitizeForm() {
          const fields = [
            'endereco', 'numero', 'bairro', 'tronco', 'chave',
            'qtd', 'alimentador', 'obs', 'data', 'equipe', 'matricula', 'ea',
            'latitude', 'longitude'
          ];
          
          const result = {};
          fields.forEach(field => {
            const element = document.getElementById(field);
            const value = element ? element.value.trim() : '';
            result[field] = this.sanitizeInput(value);
          });
          return result;
        },
        
        showStatus(message, type, target = 'status') {
          const element = document.getElementById(target);
          element.textContent = message;
          element.className = `p-3 rounded fade-in ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
          element.classList.remove('hidden');
          
          setTimeout(() => {
            element.classList.add('hidden');
          }, 5000);
        }
      },
      
      init: function() {
        this.data.load();
        this.api.autoTestConnection();
        setInterval(() => this.api.autoTestConnection(), 300000); // 5 minutos
        
        app.cache.loadFields();
        
        document.getElementById('closeDetails').addEventListener('click', () => this.details.closePanel());
        document.getElementById('overlay').addEventListener('click', () => this.details.closePanel());
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      app.init();
    });
  </script>
</body>
</html>
