<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoScanner v4.0 [Audio Feedback]</title>
    <style>
        :root { --bg: #050505; --panel: #151515; --gold: #ffd700; --water: #00bfff; --text: #eee; --alert: #ff3333; }
        body {
            margin: 0; background: var(--bg); color: var(--text);
            font-family: 'Consolas', monospace; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden; user-select: none;
        }

        /* --- TOPO E MODOS --- */
        #mode-selector {
            display: grid; grid-template-columns: 1fr 1fr;
            background: #000; border-bottom: 2px solid #333;
        }
        .mode-btn {
            padding: 15px; border: none; background: #222; color: #555;
            font-weight: bold; font-size: 1rem; cursor: pointer;
        }
        .mode-btn.active-gold { background: #332b00; color: var(--gold); border-bottom: 4px solid var(--gold); }
        .mode-btn.active-water { background: #001a33; color: var(--water); border-bottom: 4px solid var(--water); }

        /* --- HUD --- */
        #hud {
            display: grid; grid-template-columns: 1fr 1fr; gap: 4px;
            padding: 5px; background: var(--panel); font-size: 0.8rem;
        }
        .hud-box { background: #222; padding: 6px; border-radius: 4px; border-left: 2px solid #444; }
        .val { font-size: 1.2em; font-weight: bold; display: block; }
        .label { font-size: 0.7em; color: #888; }

        /* --- GR√ÅFICOS --- */
        #viewport { flex-grow: 1; position: relative; background: #000; }
        canvas { display: block; width: 100%; }
        #specCanvas { height: 40%; border-bottom: 1px solid #333; }
        #waterCanvas { height: 60%; }

        /* --- CONTROLES --- */
        #controls {
            display: flex; gap: 8px; padding: 8px; background: var(--panel); border-top: 1px solid #333;
        }
        button.ctrl {
            flex: 1; padding: 15px 0; border: none; border-radius: 4px;
            background: #333; color: white; font-weight: bold; font-size: 0.9rem;
        }
        button.active-audio { background: var(--gold); color: black; box-shadow: 0 0 10px var(--gold); }
        button.rec-active { background: var(--alert); color: white; }

        /* Ajustes */
        #tunning { padding: 10px; background: #111; display: none; border-top: 1px solid #444; }
        .slider-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
        input[type=range] { width: 60%; }

    </style>
</head>
<body>

    <div id="mode-selector">
        <button class="mode-btn active-gold" onclick="setMode('gold')">MODO OURO</button>
        <button class="mode-btn" onclick="setMode('water')">MODO √ÅGUA</button>
    </div>

    <div id="hud">
        <div class="hud-box">
            <span class="label">MAG ANOMALIA</span>
            <span id="val-mag" class="val">--</span>
        </div>
        <div class="hud-box">
            <span class="label">INTENSIDADE VLF</span>
            <span id="val-vlf" class="val">--</span>
        </div>
        <div class="hud-box">
            <span class="label">PROBABILIDADE</span>
            <span id="val-prob" class="val">0%</span>
        </div>
        <div class="hud-box">
            <span class="label">√ÅUDIO FREQ</span>
            <span id="val-freq" class="val">OFF</span>
        </div>
    </div>

    <div id="tunning">
        <div class="slider-row"><span>Sensibilidade Mag</span> <input type="range" min="1" max="100" value="20" id="sens-mag"></div>
        <div class="slider-row"><span>Volume √Åudio</span> <input type="range" min="0" max="100" value="50" id="vol-audio"></div>
    </div>

    <div id="viewport">
        <canvas id="specCanvas"></canvas>
        <canvas id="waterCanvas"></canvas>
    </div>

    <div id="controls">
        <button class="ctrl" onclick="toggleTunning()">‚öôÔ∏è</button>
        <button class="ctrl" onclick="tare()">TARA</button>
        <button class="ctrl" id="btn-audio" onclick="toggleAudio()">üîä √ÅUDIO</button>
        <button class="ctrl" onclick="startApp()">LIGAR</button>
    </div>

<script>
    // --- ESTADO GLOBAL ---
    let CONFIG = { mode: 'gold', running: false, audioEnabled: false };
    let STATE = { magBase: 0, magRaw: 0, vlfRaw: 0, lastBeep: 0 };
    
    // UI References
    const ui = {
        mag: document.getElementById('val-mag'),
        vlf: document.getElementById('val-vlf'),
        prob: document.getElementById('val-prob'),
        freq: document.getElementById('val-freq'),
        btnAudio: document.getElementById('btn-audio'),
        cSpec: document.getElementById('specCanvas'),
        cWater: document.getElementById('waterCanvas')
    };
    const ctxS = ui.cSpec.getContext('2d');
    const ctxW = ui.cWater.getContext('2d');

    // --- √ÅUDIO SYNTH (SINTETIZADOR) ---
    let synthCtx, oscillator, gainNode;

    function initSynth() {
        if(synthCtx) return;
        synthCtx = new (window.AudioContext || window.webkitAudioContext)();
        oscillator = synthCtx.createOscillator();
        gainNode = synthCtx.createGain();
        
        oscillator.type = 'sine'; // Onda senoidal (suave)
        oscillator.frequency.value = 0; // Come√ßa mudo
        gainNode.gain.value = 0; // Volume zero
        
        oscillator.connect(gainNode);
        gainNode.connect(synthCtx.destination);
        oscillator.start();
    }

    function toggleAudio() {
        CONFIG.audioEnabled = !CONFIG.audioEnabled;
        ui.btnAudio.classList.toggle('active-audio');
        if(CONFIG.audioEnabled) {
            initSynth();
            if(synthCtx.state === 'suspended') synthCtx.resume();
        } else {
            if(gainNode) gainNode.gain.setTargetAtTime(0, synthCtx.currentTime, 0.1);
            ui.freq.innerText = "OFF";
        }
    }

    // --- SENSORES ---
    let micCtx, analyser, magSensor;

    async function startApp() {
        if(CONFIG.running) return;
        CONFIG.running = true;

        // 1. MIC (VLF)
        try {
            micCtx = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } 
            });
            const src = micCtx.createMediaStreamSource(stream);
            analyser = micCtx.createAnalyser();
            analyser.fftSize = 2048;
            src.connect(analyser);
            loop();
        } catch(e) { alert("Erro Mic: " + e); }

        // 2. MAG
        if ('Magnetometer' in window) {
            try {
                magSensor = new Magnetometer({ frequency: 60 });
                magSensor.addEventListener('reading', onMagReading);
                magSensor.start();
            } catch(e) {}
        }
        setMode('gold');
    }

    function onMagReading() {
        let raw = Math.sqrt(magSensor.x**2 + magSensor.y**2 + magSensor.z**2);
        STATE.magRaw = raw;
        let delta = raw - STATE.magBase;
        
        ui.mag.innerText = (delta > 0 ? "+" : "") + delta.toFixed(2) + " ¬µT";
        
        processAudio(delta, STATE.vlfRaw);
    }

    function tare() { STATE.magBase = STATE.magRaw; }

    // --- C√âREBRO DO SOM (SONIFICA√á√ÉO) ---
    function processAudio(magDelta, vlfLevel) {
        if(!CONFIG.audioEnabled || !oscillator) return;

        let volumeInput = document.getElementById('vol-audio').value / 100; // 0.0 a 1.0
        let sensitivity = document.getElementById('sens-mag').value;

        // F√çSICA DO SOM
        // Queremos que o tom suba quanto maior for a anomalia
        let pitch = 0;
        let volume = 0;
        let absDelta = Math.abs(magDelta);

        if (CONFIG.mode === 'gold') {
            // MODO OURO: Som estilo Detector de Metal (Pitch sobe com Magnetismo)
            // Se Delta < 1 (ru√≠do natural), sil√™ncio.
            if (absDelta > 1) {
                // Mapeia anomalia (1 a 50uT) para frequ√™ncia (200Hz a 2000Hz)
                pitch = 200 + (absDelta * (sensitivity * 2)); 
                volume = Math.min((absDelta / 10) * volumeInput, volumeInput);
                ui.freq.innerText = Math.round(pitch) + " Hz";
            } else {
                volume = 0; // Sil√™ncio no "Threshold"
                ui.freq.innerText = "Quiet";
            }
        } 
        else {
            // MODO √ÅGUA: Som cont√≠nuo que CAI quando acha √°gua
            // Base 400Hz. Se VLF cair (condutor), pitch desce.
            pitch = 400 + (vlfLevel * 2); 
            volume = 0.1 * volumeInput; // Som de fundo constante
            ui.freq.innerText = "VLF Mon";
        }

        // Aplica ao sintetizador (Suavizado para n√£o estalar)
        oscillator.frequency.setTargetAtTime(pitch, synthCtx.currentTime, 0.1);
        gainNode.gain.setTargetAtTime(volume, synthCtx.currentTime, 0.1);
    }

    // --- VISUAL LOOP ---
    const dataArray = new Uint8Array(1024);
    function loop() {
        requestAnimationFrame(loop);
        analyser.getByteFrequencyData(dataArray);

        // UI Setup
        ui.cSpec.width = ui.cSpec.clientWidth; ui.cSpec.height = ui.cSpec.clientHeight;
        ui.cWater.width = ui.cWater.clientWidth; ui.cWater.height = ui.cWater.clientHeight;

        // Desenha Espectro
        ctxS.fillStyle = "#000"; ctxS.fillRect(0,0,ui.cSpec.width, ui.cSpec.height);
        ctxS.lineWidth = 2; ctxS.strokeStyle = CONFIG.mode === 'gold' ? '#ffd700' : '#00bfff';
        ctxS.beginPath();
        
        let sum = 0;
        for(let i=0; i<dataArray.length; i++) {
            let v = dataArray[i];
            let x = (i/dataArray.length) * ui.cSpec.width;
            let y = ui.cSpec.height - (v/255)*ui.cSpec.height;
            if(i===0) ctxS.moveTo(x,y); else ctxS.lineTo(x,y);
            sum += v;
        }
        ctxS.stroke();
        STATE.vlfRaw = sum / dataArray.length;
        ui.vlf.innerText = Math.round(STATE.vlfRaw);

        // Waterfall
        ctxW.drawImage(ui.cWater, 0, 0, ui.cWater.width, ui.cWater.height-1, 0, 1, ui.cWater.width, ui.cWater.height-1);
        let imgData = ctxW.createImageData(ui.cWater.width, 1);
        for(let i=0; i<ui.cWater.width; i++) {
            let idx = Math.floor((i/ui.cWater.width)*dataArray.length);
            let val = dataArray[idx];
            let p = i*4;
            if(CONFIG.mode === 'gold') { imgData.data[p]=val; imgData.data[p+1]=val>100?val:0; imgData.data[p+2]=0; }
            else { imgData.data[p]=0; imgData.data[p+1]=val; imgData.data[p+2]=val; }
            imgData.data[p+3]=255;
        }
        ctxW.putImageData(imgData, 0, 0);
    }

    function setMode(m) { CONFIG.mode = m; document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active-gold', m==='gold' && b.innerText.includes('OURO'))); }
    function toggleTunning() { let t = document.getElementById('tunning'); t.style.display = t.style.display==='block'?'none':'block'; }

</script>
</body>
</html>