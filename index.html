<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Mapas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        .sidebar {
            position: absolute;
            top: 0;
            left: 0;
            width: 300px;
            max-width: 90%;
            height: 100%;
            background-color: #ffffff;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .map-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .nav-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 999;
            display: flex;
            flex-direction: column;
        }

        .nav-buttons button {
            margin: 5px;
            padding: 10px;
            background-color: #fff;
            border: none;
            color: #333;
            font-size: 16px;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            opacity: 0.8;
            transition: opacity 0.3s, transform 0.3s;
        }

        .nav-buttons button:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .search-bar {
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .search-bar input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .search-bar button {
            width: 100%;
            padding: 10px;
            background-color: #3498db;
            color: white;
            border: none;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .search-bar button:hover {
            background-color: #2980b9;
        }

        .result {
            margin-top: 10px;
            text-align: center;
            font-size: 14px;
        }

        .result p {
            margin: 5px 0;
        }

        .result a {
            display: block;
            padding: 10px;
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            font-size: 14px;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .result a:hover {
            background-color: #2980b9;
        }

        .footer {
            margin-top: 10px;
            text-align: center;
            font-size: 12px;
            color: gray;
        }

        /* Reduzindo o tamanho dos tooltips */
        .leaflet-tooltip {
            font-size: 0.5em;
            padding: 2px 4px;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.0/dist/MarkerCluster.Default.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.0/dist/MarkerCluster.css">
</head>
<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Buscar por um ponto...">
                <button onclick="searchPoint()">Buscar</button>
            </div>
            <input type="file" id="fileInput" accept=".geojson,.kml,.kmz">
            <button onclick="loadSeTrevo()">Carregar se_trevo.kml</button>
            <div class="loader" id="loader"></div>
            <div id="fileList"></div>
            <div class="result" id="result"></div>
        </div>
        <div class="map-container">
            <div class="nav-buttons">
                <button onclick="toggleSidebar()">&#128269;</button>
                <button class="toggle-all-btn" id="toggleMarkersBtn" onclick="toggleMarkers()">&#128065;</button>
                <button class="toggle-names-btn" id="toggleNamesBtn" onclick="toggleNames()">&#128100;</button>
                <button onclick="resetView()">&#128260;</button>
                <button onclick="goToCurrentLocation()">&#128205;</button>
            </div>
            <div id="map"></div>
        </div>
        <div class="footer">
            Todos direitos reservados a Lucas Teixeira da Silva.
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/togeojson@0.16.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.0/dist/leaflet.markercluster.js"></script>
    <script>
        var map = L.map('map', { zoomControl: false }).setView([-22.907104, -47.063240], 13); // Coordenadas de Campinas

        // Adicionando camadas de base do OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
        }).addTo(map);

        var loader = document.getElementById('loader');
        var fileInput = document.getElementById('fileInput');
        var searchInput = document.getElementById('searchInput');
        var result = document.getElementById('result');
        var toggleMarkersBtn = document.getElementById('toggleMarkersBtn');
        var toggleNamesBtn = document.getElementById('toggleNamesBtn');
        var geojsonLayer;
        var markers = L.markerClusterGroup({
            maxClusterRadius: 80,
            disableClusteringAtZoom: 19
        });
        var allData;
        var searchResultsLayer;
        var markersVisible = true;
        var namesVisible = true;

        fileInput.addEventListener('change', function(e) {
            loader.style.display = 'block';

            var file = e.target.files[0];
            var reader = new FileReader();

            reader.onload = function(event) {
                var data = event.target.result;

                if (file.name.endsWith('.kml')) {
                    var geojson = toGeoJSON.kml(new DOMParser().parseFromString(data, 'text/xml'));
                    allData = geojson;
                    addDataToMap(geojson);
                } else if (file.name.endsWith('.kmz')) {
                    JSZip.loadAsync(data).then(function(zip) {
                        zip.file(Object.keys(zip.files)[0]).async('string').then(function(fileData) {
                            var geojson = toGeoJSON.kml(new DOMParser().parseFromString(fileData, 'text/xml'));
                            allData = geojson;
                            addDataToMap(geojson);
                        });
                    });
                } else if (file.name.endsWith('.geojson')) {
                    var geojsonData = JSON.parse(data);
                    allData = geojsonData;
                    addDataToMap(geojsonData);
                } else {
                    alert('Formato de arquivo não suportado. Por favor, carregue um arquivo KML, KMZ ou GeoJSON.');
                    loader.style.display = 'none';
                }
            };

            reader.onerror = function() {
                alert('Erro ao ler o arquivo.');
                loader.style.display = 'none';
            };

            reader.readAsText(file);
        });

        function loadSeTrevo() {
            loader.style.display = 'block';

            fetch('https://lucasteixeiratst.github.io/cpfl/se%20trevo.kml')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok ' + response.statusText);
                    }
                    return response.text();
                })
                .then(data => {
                    console.log("Arquivo KML carregado com sucesso.");
                    var geojson = toGeoJSON.kml(new DOMParser().parseFromString(data, 'text/xml'));
                    allData = geojson;
                    addDataToMap(geojson);
                })
                .catch(error => {
                    console.error('Erro ao carregar o arquivo se_trevo.kml:', error);
                    alert('Erro ao carregar o arquivo se_trevo.kml.');
                    loader.style.display = 'none';
                });
        }

        function addDataToMap(data) {
            if (geojsonLayer) {
                geojsonLayer.removeFrom(map);
            }
            if (markersVisible) {
                markers.clearLayers();
            }

            geojsonLayer = L.geoJSON(data, {
                onEachFeature: function(feature, layer) {
                    if (feature.properties && feature.properties.name) {
                        layer.bindTooltip(feature.properties.name, { permanent: namesVisible });
                    }
                }
            });

            markers.addLayer(geojsonLayer);
            map.addLayer(markers);

            map.fitBounds(geojsonLayer.getBounds());
            loader.style.display = 'none';
        }

        function searchPoint() {
            var searchTerm = searchInput.value.trim().toLowerCase();
            if (!searchTerm) {
                alert('Por favor, insira um termo de busca válido.');
                return;
            }

            if (searchResultsLayer) {
                searchResultsLayer.removeFrom(map);
            }

            var results = allData.features.filter(function(feature) {
                return feature.properties && feature.properties.name && feature.properties.name.toLowerCase().includes(searchTerm);
            });

            if (results.length === 0) {
                result.innerHTML = '<p>Nenhum resultado encontrado para: ' + searchTerm + '</p>';
            } else {
                result.innerHTML = '<p>Resultados para: ' + searchTerm + '</p>';
                var searchResultGeojson = {
                    type: 'FeatureCollection',
                    features: results
                };
                searchResultsLayer = L.geoJSON(searchResultGeojson, {
                    onEachFeature: function(feature, layer) {
                        layer.bindPopup('<b>' + feature.properties.name + '</b>');
                    }
                }).addTo(map);

                map.fitBounds(searchResultsLayer.getBounds());
            }
        }

        function toggleSidebar() {
            var sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        function toggleMarkers() {
            if (markersVisible) {
                markers.clearLayers();
                toggleMarkersBtn.innerText = '\u2714';
            } else {
                markers.addLayer(geojsonLayer);
                toggleMarkersBtn.innerText = '\u2715';
            }
            markersVisible = !markersVisible;
        }

        function toggleNames() {
            namesVisible = !namesVisible;
            geojsonLayer.eachLayer(function(layer) {
                layer.getTooltip().setOpacity(namesVisible ? 1 : 0);
            });
            toggleNamesBtn.innerText = namesVisible ? '\u2714' : '\u2715';
        }

        function resetView() {
            map.setView([-22.907104, -47.063240], 13); // Coordenadas de Campinas
        }

        function goToCurrentLocation() {
            map.locate({ setView: true, maxZoom: 16 });
        }
    </script>
</body>
</html>
