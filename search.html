<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Consolidador de KMZ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #357ae8;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #progress {
            margin-top: 20px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
            display: none;
        }
        #fileList {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        .file-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #e6f4ea;
            color: #0d652d;
        }
        .error {
            background-color: #fce8e6;
            color: #c5221f;
        }
        #downloadBtn {
            display: none;
            margin-top: 20px;
            background-color: #0d652d;
        }
        #downloadBtn:hover {
            background-color: #0b5a29;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Consolidador de Arquivos KMZ</h1>
        
        <div class="controls">
            <button id="loadBtn">Carregar Arquivos KMZ</button>
            <button id="consolidateBtn" disabled>Consolidar Dados</button>
            <button id="downloadBtn">Download GeoJSON</button>
        </div>
        
        <div id="progress" style="display: none;">
            <h3>Progresso:</h3>
            <div id="progressBar"></div>
        </div>
        
        <div id="fileList"></div>
        
        <div id="status"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/@tmcw/togeojson/dist/togeojson.js"></script>
    <script>
        // Estado da aplicação
        const state = {
            kmzFiles: [],
            consolidatedData: null
        };

        // Elementos do DOM
        const loadBtn = document.getElementById('loadBtn');
        const consolidateBtn = document.getElementById('consolidateBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const progressDiv = document.getElementById('progress');
        const progressBar = document.getElementById('progressBar');
        const fileListDiv = document.getElementById('fileList');
        const statusDiv = document.getElementById('status');

        // Lista de arquivos KMZ (substitua pelos seus caminhos locais)
        const kmzFiles = [
            { name: 'AGUAS DE LINDOIA.kmz', url: 'AGUAS DE LINDOIA.kmz' },
            { name: 'AGUDOS.kmz', url: 'AGUDOS.kmz' },
            // Adicione todos os 116 arquivos aqui...
            { name: 'VIRADOURO.kmz', url: 'VIRADOURO.kmz' }
        ];

        // Carrega a lista de arquivos KMZ
        loadBtn.addEventListener('click', () => {
            state.kmzFiles = [...kmzFiles];
            updateFileList();
            consolidateBtn.disabled = false;
            showStatus('Lista de arquivos KMZ carregada com sucesso!', 'success');
        });

        // Consolida os dados de todos os arquivos KMZ
        consolidateBtn.addEventListener('click', async () => {
            try {
                progressDiv.style.display = 'block';
                progressBar.innerHTML = 'Preparando...';
                
                const result = await processAllKMZFiles();
                state.consolidatedData = result;
                
                showStatus('Dados consolidados com sucesso!', 'success');
                downloadBtn.style.display = 'block';
            } catch (error) {
                console.error('Erro ao consolidar dados:', error);
                showStatus(`Erro ao consolidar dados: ${error.message}`, 'error');
            } finally {
                progressDiv.style.display = 'none';
            }
        });

        // Download do GeoJSON consolidado
        downloadBtn.addEventListener('click', () => {
            if (!state.consolidatedData) return;
            
            const dataStr = JSON.stringify(state.consolidatedData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dados_consolidados.geojson';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Atualiza a lista de arquivos na interface
        function updateFileList() {
            fileListDiv.innerHTML = '';
            state.kmzFiles.forEach(file => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.textContent = file.name;
                fileListDiv.appendChild(div);
            });
        }

        // Mostra mensagens de status
        function showStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = type;
        }

        // Processa todos os arquivos KMZ
        async function processAllKMZFiles() {
            const consolidatedGeoJSON = {
                type: 'FeatureCollection',
                features: []
            };
            
            for (let i = 0; i < state.kmzFiles.length; i++) {
                const file = state.kmzFiles[i];
                const progress = Math.floor((i / state.kmzFiles.length) * 100);
                progressBar.innerHTML = `Processando ${file.name}... (${i+1}/${state.kmzFiles.length}, ${progress}%)`;
                
                try {
                    const response = await fetch(file.url);
                    if (!response.ok) {
                        throw new Error(`Falha ao carregar ${file.name}: ${response.status}`);
                    }
                    
                    let geoJSON;
                    if (file.name.endsWith('.kmz')) {
                        const arrayBuffer = await response.arrayBuffer();
                        geoJSON = await parseKMZ(arrayBuffer);
                    } else {
                        const text = await response.text();
                        const kml = new DOMParser().parseFromString(text, 'text/xml');
                        geoJSON = toGeoJSON.kml(kml);
                    }
                    
                    // Adiciona metadados do arquivo de origem
                    geoJSON.features.forEach(feature => {
                        feature.properties = feature.properties || {};
                        feature.properties.sourceFile = file.name;
                        consolidatedGeoJSON.features.push(feature);
                    });
                    
                } catch (error) {
                    console.error(`Erro ao processar ${file.name}:`, error);
                    // Continua para o próximo arquivo mesmo se um falhar
                }
            }
            
            return consolidatedGeoJSON;
        }

        // Converte KMZ para GeoJSON
        async function parseKMZ(arrayBuffer) {
            const zip = await JSZip.loadAsync(arrayBuffer);
            const kmlFile = zip.file(/\.kml$/i)[0];
            if (!kmlFile) {
                throw new Error('Arquivo KML não encontrado no KMZ');
            }
            const kmlContent = await kmlFile.async('text');
            const kml = new DOMParser().parseFromString(kmlContent, 'text/xml');
            return toGeoJSON.kml(kml);
        }
    </script>
</body>
</html>
