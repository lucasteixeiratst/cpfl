<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cadastro de Servi√ßos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .status-hidden { display: none; }
    .fade-in { animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    select[multiple] { scrollbar-width: thin; }
    select[multiple]::-webkit-scrollbar { width: 6px; }
    select[multiple]::-webkit-scrollbar-thumb { background: #007bff; border-radius: 4px; }
  </style>
</head>
<body class="bg-gray-100 font-sans min-h-screen flex items-center justify-center p-4">
  <div class="container max-w-5xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
    <h2 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-6">Cadastro de Servi√ßos</h2>

    <!-- Se√ß√£o de Testes -->
    <div class="mb-8 p-4 bg-gray-50 rounded-lg shadow-inner">
      <h3 class="text-lg font-semibold text-gray-700 mb-4">Testes de Conex√£o</h3>
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <button onclick="testarBackend()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition-all duration-200 flex items-center justify-center">
          <span>üîó Testar Backend</span>
        </button>
        <button onclick="testarBanco()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition-all duration-200 flex items-center justify-center">
          <span>üóÑÔ∏è Testar Banco</span>
        </button>
        <button onclick="testarServicos()" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition-all duration-200 flex items-center justify-center">
          <span>üìã Testar Servi√ßos</span>
        </button>
      </div>
      <div id="statusTestes" class="mt-4 p-3 rounded-lg text-white status-hidden" aria-live="assertive"></div>
    </div>

    <!-- Formul√°rio -->
    <div id="formulario" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"></div>

    <!-- Bot√µes do Formul√°rio -->
    <div class="flex flex-wrap gap-3 mb-6">
      <button onclick="pegarLatLon()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition-all duration-200 flex items-center">
        <span>üìç Localizar</span>
      </button>
      <button onclick="pegarEndereco()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition-all duration-200 flex items-center">
        <span>üè† Buscar Endere√ßo</span>
      </button>
      <button id="salvarBtn" onclick="salvar()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition-all duration-200 flex items-center">
        <span>üíæ Salvar</span>
      </button>
      <button onclick="limparFormulario()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition-all duration-200 flex items-center">
        <span>üßπ Limpar</span>
      </button>
    </div>

    <!-- Mensagem de Status -->
    <div id="status" class="mb-6 p-3 rounded-lg text-white status-hidden" aria-live="assertive"></div>

    <!-- Tabela -->
    <div class="overflow-x-auto">
      <table id="tabela" class="w-full border-collapse bg-white shadow-md rounded-lg">
        <thead>
          <tr class="bg-blue-500 text-white">
            <th class="p-3 text-left">Endere√ßo</th>
            <th class="p-3 text-left">N√∫mero</th>
            <th class="p-3 text-left">Bairro</th>
            <th class="p-3 text-left">Tronco</th>
            <th class="p-3 text-left">Chave</th>
            <th class="p-3 text-left">Qtd</th>
            <th class="p-3 text-left">Alimentador</th>
            <th class="p-3 text-left">Obs</th>
            <th class="p-3 text-left">Data</th>
            <th class="p-3 text-left">Equipe</th>
            <th class="p-3 text-left">Matr√≠cula</th>
            <th class="p-3 text-left">EA</th>
            <th class="p-3 text-left">Servi√ßo</th>
            <th class="p-3 text-left">Lat</th>
            <th class="p-3 text-left">Lon</th>
            <th class="p-3 text-left">A√ß√µes</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const BASE_URL = 'https://fonseca.onrender.com';
    let editId = null;

    const campos = [
      ['Endere√ßo', 'endereco'],
      ['N√∫mero', 'numero'],
      ['Bairro', 'bairro'],
      ['Tronco', 'tronco'],
      ['Chave', 'chave'],
      ['Quantidade', 'qtd', 'number'],
      ['Alimentador', 'alimentador'],
      ['Observa√ß√£o', 'obs', 'textarea'],
      ['Data', 'data', 'date'],
      ['Equipe', 'equipe'],
      ['Matr√≠cula', 'matricula'],
      ['EA', 'ea'],
      ['Latitude', 'latitude', 'text', true],
      ['Longitude', 'longitude', 'text', true]
    ];

    const formulario = document.getElementById('formulario');
    campos.forEach(([label, id, tipo = 'text', readonly = false]) => {
      const div = document.createElement('div');
      div.className = 'flex flex-col';
      div.innerHTML = `
        <label for="${id}" class="text-gray-700 font-semibold mb-1">${label}</label>
        ${tipo === 'textarea'
          ? `<textarea id="${id}" ${readonly ? 'readonly' : ''} class="p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="${label}"></textarea>`
          : `<input type="${tipo}" id="${id}" ${readonly ? 'readonly' : ''} class="p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="${label}" />`
        }
      `;
      formulario.appendChild(div);
    });

    // Servi√ßo (select)
    const divServico = document.createElement('div');
    divServico.className = 'flex flex-col';
    divServico.innerHTML = `
      <label for="servico" class="text-gray-700 font-semibold mb-1">Servi√ßo (Selecione um ou mais)</label>
      <select id="servico" multiple size="6" class="p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Sele√ß√£o de servi√ßos">
        <option value="PC">Poda prim√°ria completa - PC</option>
        <option value="PS">Poda secund√°ria completa - PS</option>
        <option value="PP">Poda prim√°ria parcial - PP</option>
        <option value="SP">Poda secund√°ria parcial - SP</option>
        <option value="U">Cruzeta urgente troca em 15 dias - U</option>
        <option value="CV">Corte de cerca viva - CV</option>
        <option value="A">Cruzeta alta para 90 dias - A</option>
      </select>
    `;
    formulario.appendChild(divServico);

    let lastGeolocationCall = 0;
    const debounceDelay = 1000;

    function sanitizeInput(input) {
      const div = document.createElement('div');
      div.textContent = input;
      return div.innerHTML;
    }

    function showStatus(message, type, target = 'status') {
      const status = document.getElementById(target);
      status.textContent = message;
      status.className = `p-3 rounded-lg text-white fade-in ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      status.classList.remove('status-hidden');
      setTimeout(() => status.classList.add('status-hidden'), 5000);
    }

    // Fun√ß√µes de Teste
    async function testarBackend() {
      try {
        const response = await fetch(BASE_URL);
        if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
        const data = await response.json();
        showStatus('Backend conectado com sucesso! Mensagem: ' + data.message, 'success', 'statusTestes');
      } catch (err) {
        showStatus('Erro ao conectar ao backend: ' + err.message, 'error', 'statusTestes');
      }
    }

    async function testarBanco() {
      try {
        const response = await fetch(`${BASE_URL}/test-db`);
        if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
        const data = await response.json();
        if (data.success) {
          showStatus('Conex√£o com o banco de dados bem-sucedida! Hor√°rio: ' + data.time, 'success', 'statusTestes');
        } else {
          throw new Error(data.error);
        }
      } catch (err) {
        showStatus('Erro ao conectar ao banco: ' + err.message, 'error', 'statusTestes');
      }
    }

    async function testarServicos() {
      try {
        const response = await fetch(`${BASE_URL}/servicos`);
        if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
        const data = await response.json();
        showStatus(`Endpoint /servicos funcionando! ${data.length} registros encontrados.`, 'success', 'statusTestes');
      } catch (err) {
        showStatus('Erro ao acessar /servicos: ' + err.message, 'error', 'statusTestes');
      }
    }

    function pegarLatLon() {
      if (Date.now() - lastGeolocationCall < debounceDelay) {
        showStatus('Aguarde antes de tentar novamente.', 'error');
        return;
      }
      lastGeolocationCall = Date.now();

      if (!navigator.geolocation) {
        showStatus('Geolocaliza√ß√£o n√£o suportada pelo seu navegador.', 'error');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          document.getElementById('latitude').value = pos.coords.latitude.toFixed(6);
          document.getElementById('longitude').value = pos.coords.longitude.toFixed(6);
          showStatus('Coordenadas obtidas com sucesso!', 'success');
        },
        err => {
          showStatus('Erro ao obter localiza√ß√£o: ' + err.message, 'error');
        }
      );
    }

    function pegarEndereco() {
      if (Date.now() - lastGeolocationCall < debounceDelay) {
        showStatus('Aguarde antes de tentar novamente.', 'error');
        return;
      }
      lastGeolocationCall = Date.now();

      if (!navigator.onLine) {
        showStatus('Sem conex√£o com a internet. Insira o endere√ßo manualmente.', 'error');
        document.getElementById('endereco').focus();
        return;
      }
      if (!navigator.geolocation) {
        showStatus('Geolocaliza√ß√£o n√£o suportada. Insira o endere√ßo manualmente.', 'error');
        document.getElementById('endereco').focus();
        return;
      }

      showStatus('Buscando endere√ßo...', 'success');

      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;

          fetch(url, {
            headers: { 'User-Agent': 'CadastroServicos/1.0 (lucas.teixeira.tst@hotmail.com)' }
          })
            .then(res => {
              if (!res.ok) throw new Error(`Erro HTTP: ${res.status}`);
              return res.json();
            })
            .then(data => {
              const address = data.address || {};
              const rua = sanitizeInput(address.road || address.street || '');
              const numero = sanitizeInput(address.housenumber || '');
              const bairro = sanitizeInput(address.suburb || address.neighbourhood || '');
              const cidade = sanitizeInput(address.city || address.town || address.village || '');

              document.getElementById('endereco').value = rua ? `${rua}${cidade ? ', ' + cidade : ''}` : '';
              document.getElementById('numero').value = numero;
              document.getElementById('bairro').value = bairro;
              document.getElementById('latitude').value = lat.toFixed(6);
              document.getElementById('longitude').value = lon.toFixed(6);

              showStatus('Endere√ßo obtido com sucesso!', 'success');
              document.getElementById('endereco').focus();
            })
            .catch(err => {
              showStatus(`Erro ao buscar endere√ßo: ${err.message}. Insira manualmente.`, 'error');
              document.getElementById('endereco').focus();
            });
        },
        err => {
          showStatus('Erro ao obter localiza√ß√£o: ' + err.message + '. Insira manualmente.', 'error');
          document.getElementById('endereco').focus();
        }
      );
    }

    async function salvar() {
      const endereco = document.getElementById('endereco').value.trim();
      const qtd = document.getElementById('qtd').value.trim();
      const data = document.getElementById('data').value;
      const servicosSelecionados = Array.from(document.getElementById('servico').selectedOptions).map(opt => opt.text);

      if (!endereco) {
        showStatus('Endere√ßo √© obrigat√≥rio.', 'error');
        return;
      }
      if (!servicosSelecionados.length) {
        showStatus('Selecione pelo menos um servi√ßo.', 'error');
        return;
      }
      if (qtd && (isNaN(qtd) || qtd < 0)) {
        showStatus('Quantidade deve ser um n√∫mero positivo.', 'error');
        return;
      }
      if (data && new Date(data) > new Date()) {
        showStatus('A data n√£o pode ser futura.', 'error');
        return;
      }

      const item = {
        id: editId || Date.now(),
        ...Object.fromEntries(campos.map(([, id]) => [id, sanitizeInput(document.getElementById(id).value.trim())])),
        servicos: servicosSelecionados
      };

      try {
        const method = editId ? 'PUT' : 'POST';
        const url = editId ? `${BASE_URL}/servicos/${editId}` : `${BASE_URL}/servicos`;
        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(item)
        });
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `Erro HTTP: ${response.status} (${response.statusText})`);
        }
        await atualizarTabela();
        limparFormulario();
        showStatus(editId ? 'Registro atualizado com sucesso!' : 'Registro salvo com sucesso!', 'success');
        editId = null;
        document.getElementById('salvarBtn').innerHTML = '<span>üíæ Salvar</span>';
      } catch (err) {
        console.error('Erro na requisi√ß√£o:', err);
        showStatus(`Erro ao ${editId ? 'atualizar' : 'salvar'}: ${err.message}. Verifique o servidor em ${BASE_URL}.`, 'error');
      }
    }

    function limparFormulario() {
      campos.forEach(([, id]) => document.getElementById(id).value = '');
      document.getElementById('servico').selectedIndex = -1;
      editId = null;
      document.getElementById('salvarBtn').innerHTML = '<span>üíæ Salvar</span>';
      document.getElementById('endereco').focus();
    }

    async function atualizarTabela() {
      try {
        const response = await fetch(`${BASE_URL}/servicos`);
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `Erro HTTP: ${response.status} (${response.statusText})`);
        }
        const dados = await response.json();

        const tbody = document.querySelector('#tabela tbody');
        tbody.innerHTML = '';
        dados.forEach(item => {
          const tr = document.createElement('tr');
          tr.className = 'border-t hover:bg-gray-50';
          const cells = [
            item.endereco,
            item.numero,
            item.bairro,
            item.tronco,
            item.chave,
            item.qtd,
            item.alimentador,
            item.obs,
            item.data,
            item.equipe,
            item.matricula,
            item.ea,
            item.servicos,
            item.latitude,
            item.longitude
          ];

          cells.forEach(cell => {
            const td = document.createElement('td');
            td.className = 'p-3 text-gray-700';
            td.textContent = cell || '';
            tr.appendChild(td);
          });

          const actionTd = document.createElement('td');
          actionTd.className = 'p-3 flex gap-2';
          const editButton = document.createElement('button');
          editButton.innerHTML = '‚úèÔ∏è';
          editButton.className = 'text-blue-500 hover:text-blue-700';
          editButton.setAttribute('aria-label', 'Editar este registro');
          editButton.onclick = () => {
            editId = item.id;
            campos.forEach(([, id]) => document.getElementById(id).value = item[id] || '');
            const select = document.getElementById('servico');
            Array.from(select.options).forEach(opt => opt.selected = item.servicos.split(', ').includes(opt.text));
            document.getElementById('salvarBtn').innerHTML = '<span>üíæ Atualizar</span>';
            document.getElementById('endereco').focus();
          };
          actionTd.appendChild(editButton);

          const deleteButton = document.createElement('button');
          deleteButton.innerHTML = 'üóëÔ∏è';
          deleteButton.className = 'text-red-500 hover:text-red-700';
          deleteButton.setAttribute('aria-label', 'Excluir este registro');
          deleteButton.onclick = () => excluir(item.id);
          actionTd.appendChild(deleteButton);

          tr.appendChild(actionTd);
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error('Erro ao carregar tabela:', err);
        showStatus(`Erro ao carregar dados: ${err.message}. Verifique o servidor em ${BASE_URL}.`, 'error');
      }
    }

    async function excluir(id) {
      if (!confirm('Deseja realmente excluir?')) return;
      try {
        const response = await fetch(`${BASE_URL}/servicos/${id}`, {
          method: 'DELETE'
        });
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `Erro HTTP: ${response.status} (${response.statusText})`);
        }
        await atualizarTabela();
        showStatus('Registro exclu√≠do com sucesso!', 'success');
      } catch (err) {
        console.error('Erro ao excluir:', err);
        showStatus(`Erro ao excluir: ${err.message}. Verifique o servidor em ${BASE_URL}.`, 'error');
      }
    }

    // Inicializar a tabela
    atualizarTabela();
  </script>
</body>
</html>
