<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mapa com MapLibre + Supabase</title>
  <link
    href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css"
    rel="stylesheet"
  />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- MapLibre GL JS -->
  <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
  <!-- Supabase JS Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // === CONFIGURAÇÃO SUPABASE ===
    const SUPABASE_URL = https://apwforodphfoorwhaqdo.supabase.co;
    const SUPABASE_ANON_KEY = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFwd2Zvcm9kcGhmb29yd2hhcWRvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkwODQ5ODcsImV4cCI6MjA2NDY2MDk4N30.lmLDwaDpYPs32K5fL-aU8wgMJy5U8za0r91jJCiT9vc;
    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // === INICIALIZAÇÃO DO MAPA ===
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://demotiles.maplibre.org/style.json', // estilo de teste
      center: [-47.068847, -22.934973],
      zoom: 11
    });

    map.on('load', () => {
      carregarDados();
    });

    map.on('moveend', () => {
      carregarDados();
    });

    // === FUNÇÕES PRINCIPAIS ===

    async function carregarDados() {
      const bounds = map.getBounds();
      const sw = bounds.getSouthWest();
      const ne = bounds.getNorthEast();
      const bbox = `POLYGON((${sw.lng} ${sw.lat}, ${ne.lng} ${sw.lat}, ${ne.lng} ${ne.lat}, ${sw.lng} ${ne.lat}, ${sw.lng} ${sw.lat}))`;

      limparCamadas();

      await Promise.all([
        buscarEAdicionar('markers', addMarkers),
        buscarEAdicionar('lines', addLines),
        buscarEAdicionar('polygons', addPolygons)
      ]);
    }

    function limparCamadas() {
      ['markers-src', 'lines-src', 'polygons-src'].forEach(id => {
        if (map.getLayer(id + '-layer')) map.removeLayer(id + '-layer');
        if (map.getSource(id)) map.removeSource(id);
      });
    }

    async function buscarEAdicionar(tabela, callback) {
      try {
        const { data, error } = await supabase
          .from(tabela)
          .select('*')
          .filter('coordinates', 'st_intersects', bbox);

        if (error) throw error;
        if (data && data.length) {
          callback(data);
        }
      } catch (err) {
        console.error(`Erro ao buscar ${tabela}:`, err);
      }
    }

    function addMarkers(items) {
      const geojson = {
        type: 'FeatureCollection',
        features: items.map(m => ({
          type: 'Feature',
          properties: { title: m.name },
          geometry: m.coordinates
        }))
      };

      map.addSource('markers-src', { type: 'geojson', data: geojson });
      map.addLayer({
        id: 'markers-src-layer',
        type: 'circle',
        source: 'markers-src',
        paint: {
          'circle-radius': 6,
          'circle-color': '#E63946',
          'circle-stroke-width': 2,
          'circle-stroke-color': '#FFF'
        }
      });
    }

    function addLines(items) {
      const geojson = {
        type: 'FeatureCollection',
        features: items.map(l => ({
          type: 'Feature',
          properties: {},
          geometry: l.coordinates
        }))
      };

      map.addSource('lines-src', { type: 'geojson', data: geojson });
      map.addLayer({
        id: 'lines-src-layer',
        type: 'line',
        source: 'lines-src',
        paint: { 'line-color': '#457B9D', 'line-width': 4 }
      });
    }

    function addPolygons(items) {
      const geojson = {
        type: 'FeatureCollection',
        features: items.map(p => ({
          type: 'Feature',
          properties: {},
          geometry: p.coordinates
        }))
      };

      map.addSource('polygons-src', { type: 'geojson', data: geojson });
      map.addLayer({
        id: 'polygons-src-layer',
        type: 'fill',
        source: 'polygons-src',
        paint: { 'fill-color': '#2A9D8F', 'fill-opacity': 0.4 }
      });
    }
  </script>
</body>
</html>
