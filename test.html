<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoScanner v5.0 [DSP Filters]</title>
    <style>
        :root { --bg: #050505; --panel: #151515; --gold: #ffd700; --water: #00bfff; --text: #eee; --alert: #ff3333; --on: #0f0; }
        body {
            margin: 0; background: var(--bg); color: var(--text);
            font-family: 'Consolas', monospace; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden; user-select: none;
        }

        /* --- UI ELEMENTS --- */
        #hud {
            display: grid; grid-template-columns: 1fr 1fr; gap: 4px;
            padding: 5px; background: var(--panel); border-bottom: 1px solid #333;
        }
        .hud-box { background: #222; padding: 5px; border-left: 3px solid #444; }
        .val { font-size: 1.1em; font-weight: bold; display: block; }
        .label { font-size: 0.7em; color: #888; }
        .active-filter { border-left-color: var(--on); color: var(--on); }

        #viewport { flex-grow: 1; position: relative; background: #000; }
        canvas { display: block; width: 100%; }
        #specCanvas { height: 40%; border-bottom: 1px solid #333; }
        #waterCanvas { height: 60%; }

        #controls {
            display: flex; gap: 8px; padding: 8px; background: var(--panel); border-top: 1px solid #333;
        }
        button.ctrl {
            flex: 1; padding: 12px 0; border: none; border-radius: 4px;
            background: #333; color: white; font-weight: bold; font-size: 0.8rem;
        }
        button.active { background: var(--gold); color: black; }
        
        /* MENU DE AJUSTES (FILTROS) */
        #dsp-panel {
            background: #1a1a1a; padding: 15px; display: none;
            border-top: 2px solid var(--gold);
        }
        .dsp-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 5px;
        }
        .switch {
            position: relative; display: inline-block; width: 50px; height: 24px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 24px;
        }
        .slider:before {
            position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--gold); }
        input:checked + .slider:before { transform: translateX(26px); }

    </style>
</head>
<body>

    <div id="hud">
        <div class="hud-box">
            <span class="label">MAG ANOMALIA</span>
            <span id="val-mag" class="val">--</span>
        </div>
        <div class="hud-box">
            <span class="label">VLF SIGNAL</span>
            <span id="val-vlf" class="val">--</span>
        </div>
        <div class="hud-box" id="box-filter-60">
            <span class="label">FILTRO 60Hz</span>
            <span class="val">OFF</span>
        </div>
        <div class="hud-box" id="box-filter-hp">
            <span class="label">FILTRO RUMBLE</span>
            <span class="val">OFF</span>
        </div>
    </div>

    <div id="dsp-panel">
        <div class="dsp-row">
            <span>üîå KILL 60Hz (Rede El√©trica)</span>
            <label class="switch">
                <input type="checkbox" id="chk-60hz" onchange="updateFilters()">
                <span class="slider"></span>
            </label>
        </div>
        <div class="dsp-row">
            <span>üõë KILL 120Hz (Harm√¥nico)</span>
            <label class="switch">
                <input type="checkbox" id="chk-120hz" onchange="updateFilters()">
                <span class="slider"></span>
            </label>
        </div>
        <div class="dsp-row">
            <span>üí® Low Cut (>100Hz)</span>
            <label class="switch">
                <input type="checkbox" id="chk-hp" onchange="updateFilters()">
                <span class="slider"></span>
            </label>
        </div>
        <div style="text-align: center; color: #888; font-size: 0.8em;">
            Ative para limpar o gr√°fico em √°reas urbanas.
        </div>
    </div>

    <div id="viewport">
        <canvas id="specCanvas"></canvas>
        <canvas id="waterCanvas"></canvas>
    </div>

    <div id="controls">
        <button class="ctrl" onclick="toggleDSP()">‚öôÔ∏è FILTROS</button>
        <button class="ctrl" onclick="tare()">ZERAR</button>
        <button class="ctrl" id="btn-audio" onclick="toggleAudio()">üîä SOM</button>
        <button class="ctrl" onclick="startApp()">LIGAR</button>
    </div>

<script>
    // --- AUDIO CONTEXT GLOBAL ---
    let audioCtx, micSource, analyser;
    // Nodos de Filtro
    let filter60, filter120, filterHP, gainNode;
    let synthOsc, synthGain; // Para o som de feedback
    
    let STATE = {
        running: false,
        audioOn: false,
        magBase: 0,
        filters: { f60: false, f120: false, hp: false }
    };

    const ui = {
        mag: document.getElementById('val-mag'),
        vlf: document.getElementById('val-vlf'),
        dsp: document.getElementById('dsp-panel'),
        box60: document.getElementById('box-filter-60'),
        boxHP: document.getElementById('box-filter-hp'),
        cSpec: document.getElementById('specCanvas'),
        cWater: document.getElementById('waterCanvas')
    };
    const ctxS = ui.cSpec.getContext('2d');
    const ctxW = ui.cWater.getContext('2d');

    // --- 1. INICIALIZA√á√ÉO DE √ÅUDIO COM DSP ---
    async function startApp() {
        if(STATE.running) return;
        
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } 
            });
            
            // Cria√ß√£o da Cadeia de √Åudio
            micSource = audioCtx.createMediaStreamSource(stream);
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 2048;

            // Criar Filtros (Ainda desconectados)
            createFilters();

            // Conectar Tudo: Mic -> Filtros -> Analyser
            reconnectChain();
            
            // Iniciar Magnet√¥metro
            initMag();
            
            STATE.running = true;
            loop();
        } catch(e) { alert("Erro: " + e); }
    }

    function createFilters() {
        // Filtro Notch 60Hz (Corte Cir√∫rgico)
        filter60 = audioCtx.createBiquadFilter();
        filter60.type = 'notch';
        filter60.frequency.value = 60;
        filter60.Q.value = 10; // Q alto = corte estreito (n√£o estraga o resto)

        // Filtro Notch 120Hz (Primeiro Harm√¥nico)
        filter120 = audioCtx.createBiquadFilter();
        filter120.type = 'notch';
        filter120.frequency.value = 120;
        filter120.Q.value = 10;

        // Filtro HighPass (Remove rumble < 100Hz)
        filterHP = audioCtx.createBiquadFilter();
        filterHP.type = 'highpass';
        filterHP.frequency.value = 100;
        filterHP.Q.value = 0.5;
    }

    // --- 2. L√ìGICA DE CONEX√ÉO DOS FILTROS ---
    function updateFilters() {
        STATE.filters.f60 = document.getElementById('chk-60hz').checked;
        STATE.filters.f120 = document.getElementById('chk-120hz').checked;
        STATE.filters.hp = document.getElementById('chk-hp').checked;

        // Atualiza UI
        ui.box60.querySelector('.val').innerText = STATE.filters.f60 ? "ON" : "OFF";
        ui.box60.classList.toggle('active-filter', STATE.filters.f60);
        ui.boxHP.querySelector('.val').innerText = STATE.filters.hp ? "ON" : "OFF";
        ui.boxHP.classList.toggle('active-filter', STATE.filters.hp);

        if(audioCtx) reconnectChain();
    }

    function reconnectChain() {
        // Desconecta tudo primeiro para evitar erros
        micSource.disconnect();
        filter60.disconnect();
        filter120.disconnect();
        filterHP.disconnect();

        // Recria a corrente baseada nos checkboxes
        let currentNode = micSource;

        if (STATE.filters.hp) {
            currentNode.connect(filterHP);
            currentNode = filterHP;
        }
        if (STATE.filters.f60) {
            currentNode.connect(filter60);
            currentNode = filter60;
        }
        if (STATE.filters.f120) {
            currentNode.connect(filter120);
            currentNode = filter120;
        }

        // Finaliza no Analisador
        currentNode.connect(analyser);
    }

    // --- 3. MAGNET√îMETRO ---
    let magSensor;
    function initMag() {
        if ('Magnetometer' in window) {
            magSensor = new Magnetometer({ frequency: 60 });
            magSensor.addEventListener('reading', () => {
                let raw = Math.sqrt(magSensor.x**2 + magSensor.y**2 + magSensor.z**2);
                let delta = raw - STATE.magBase;
                ui.mag.innerText = (delta > 0 ? "+" : "") + delta.toFixed(2) + " ¬µT";
                
                // Feedback Sonoro
                if(STATE.audioOn && synthOsc) {
                    let pitch = 200 + (Math.abs(delta) * 50);
                    let vol = Math.min(Math.abs(delta) / 20, 1);
                    if(Math.abs(delta) < 1) vol = 0; // Noise gate
                    
                    synthOsc.frequency.setTargetAtTime(pitch, audioCtx.currentTime, 0.1);
                    synthGain.gain.setTargetAtTime(vol, audioCtx.currentTime, 0.1);
                }
            });
            magSensor.start();
        }
    }
    function tare() { 
        if(magSensor) STATE.magBase = Math.sqrt(magSensor.x**2 + magSensor.y**2 + magSensor.z**2); 
    }

    // --- 4. √ÅUDIO FEEDBACK ---
    function toggleAudio() {
        STATE.audioOn = !STATE.audioOn;
        document.getElementById('btn-audio').classList.toggle('active');
        
        if(STATE.audioOn && audioCtx) {
            synthOsc = audioCtx.createOscillator();
            synthGain = audioCtx.createGain();
            synthOsc.connect(synthGain);
            synthGain.connect(audioCtx.destination);
            synthGain.gain.value = 0;
            synthOsc.start();
        } else if(synthOsc) {
            synthOsc.stop();
            synthOsc = null;
        }
    }

    // --- LOOP VISUAL ---
    const dataArray = new Uint8Array(2048);
    function loop() {
        requestAnimationFrame(loop);
        analyser.getByteFrequencyData(dataArray);

        // Setup Canvas
        ui.cSpec.width = ui.cSpec.clientWidth; ui.cSpec.height = ui.cSpec.clientHeight;
        ui.cWater.width = ui.cWater.clientWidth; ui.cWater.height = ui.cWater.clientHeight;

        // Espectro
        ctxS.fillStyle = "#000"; ctxS.fillRect(0,0,ui.cSpec.width, ui.cSpec.height);
        ctxS.lineWidth = 2; ctxS.strokeStyle = "#ffd700"; ctxS.beginPath();
        let sum = 0;
        for(let i=0; i<dataArray.length; i++) {
            let v = dataArray[i];
            let x = (i/dataArray.length) * ui.cSpec.width;
            let y = ui.cSpec.height - (v/255)*ui.cSpec.height;
            if(i===0) ctxS.moveTo(x,y); else ctxS.lineTo(x,y);
            sum += v;
        }
        ctxS.stroke();
        ui.vlf.innerText = Math.round(sum/dataArray.length);

        // Waterfall
        ctxW.drawImage(ui.cWater, 0, 0, ui.cWater.width, ui.cWater.height-1, 0, 1, ui.cWater.width, ui.cWater.height-1);
        let imgData = ctxW.createImageData(ui.cWater.width, 1);
        for(let i=0; i<ui.cWater.width; i++) {
            let idx = Math.floor((i/ui.cWater.width)*dataArray.length);
            let val = dataArray[idx];
            let p = i*4;
            imgData.data[p] = val; imgData.data[p+1] = val>120?val:0; imgData.data[p+2] = 0; imgData.data[p+3] = 255;
        }
        ctxW.putImageData(imgData, 0, 0);
    }

    function toggleDSP() {
        let p = ui.dsp; p.style.display = p.style.display==='block'?'none':'block';
    }

</script>
</body>
</html>