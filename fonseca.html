<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cadastro de Servi√ßos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in { animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    select[multiple] { scrollbar-width: thin; }
    select[multiple]::-webkit-scrollbar { width: 6px; }
    select[multiple]::-webkit-scrollbar-thumb { background: #0078d7; border-radius: 4px; }
    .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .status-green { background-color: #107c10; }
    .status-red { background-color: #d13438; }
    .ms-card { border-radius: 4px; box-shadow: 0 0 8px rgba(0, 0, 0, 0.1); }
    .ms-button { border-radius: 4px; font-weight: 600; transition: all 0.2s; }
    .ms-button-primary { background-color: #0078d7; color: white; }
    .ms-button-primary:hover { background-color: #106ebe; }
    .ms-button-success { background-color: #107c10; color: white; }
    .ms-button-success:hover { background-color: #0e6b0e; }
    .ms-button-neutral { background-color: #f4f4f4; color: #333; }
    .ms-button-neutral:hover { background-color: #eaeaea; }
    .ms-form-label { font-weight: 600; color: #323130; margin-bottom: 4px; }
    .ms-form-input { border: 1px solid #edebe9; border-radius: 4px; padding: 8px; }
    .ms-form-input:focus { outline: 2px solid #0078d7; outline-offset: -1px; }
    .ms-table { border-collapse: separate; border-spacing: 0; }
    .ms-table th { background-color: #f3f2f1; font-weight: 600; color: #323130; }
    .ms-table th, .ms-table td { padding: 12px; border-bottom: 1px solid #edebe9; text-align: left; }
    .ms-status-bar { background-color: #0078d7; color: white; padding: 8px; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col font-segoe">
  <header class="bg-white shadow-sm">
    <div class="container max-w-6xl mx-auto px-4 py-3 flex items-center">
      <div class="flex items-center">
        <div class="bg-gray-200 border-2 border-dashed rounded-xl w-16 h-16" />
        <div class="ml-4">
          <h1 class="text-2xl font-semibold text-gray-800">Cadastro de Servi√ßos</h1>
          <p class="text-gray-600">Sistema de gerenciamento de servi√ßos de poda</p>
        </div>
      </div>
    </div>
  </header>

  <div class="container max-w-6xl mx-auto p-4 flex-grow">
    <div class="ms-card bg-white p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- Painel de Geolocaliza√ß√£o -->
        <div class="ms-card bg-gray-50 p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Geolocaliza√ß√£o</h3>
          <div class="flex flex-col space-y-3">
            <button onclick="app.geolocation.getAddress()" class="ms-button ms-button-primary py-2 px-4 flex items-center justify-center">
              <span class="mr-2">üè†</span> Preencher Endere√ßo Autom√°tico
            </button>
            <button onclick="app.geolocation.getCoordinates()" class="ms-button ms-button-primary py-2 px-4 flex items-center justify-center">
              <span class="mr-2">üìç</span> Obter Coordenadas
            </button>
          </div>
          <div class="grid grid-cols-2 gap-3 mt-4">
            <div>
              <label class="ms-form-label">Latitude</label>
              <input type="text" id="latitude" class="ms-form-input w-full" readonly>
            </div>
            <div>
              <label class="ms-form-label">Longitude</label>
              <input type="text" id="longitude" class="ms-form-input w-full" readonly>
            </div>
          </div>
        </div>

        <!-- Painel de Testes -->
        <div class="ms-card bg-gray-50 p-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-3">Testes de Conex√£o</h3>
          <div class="grid grid-cols-1 gap-3">
            <button onclick="app.tests.testBackend()" class="ms-button ms-button-neutral py-2 px-4 flex items-center justify-center">
              <span class="mr-2">üîó</span> Testar Backend
            </button>
            <button onclick="app.tests.testDatabase()" class="ms-button ms-button-neutral py-2 px-4 flex items-center justify-center">
              <span class="mr-2">üóÑÔ∏è</span> Testar Banco de Dados
            </button>
            <button onclick="app.tests.testServices()" class="ms-button ms-button-neutral py-2 px-4 flex items-center justify-center">
              <span class="mr-2">üìã</span> Testar Servi√ßos
            </button>
          </div>
          <div id="statusTestes" class="mt-4 p-3 rounded text-sm hidden"></div>
        </div>
      </div>

      <!-- Formul√°rio -->
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Registro de Servi√ßos</h3>
      <form id="formulario" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <!-- Coluna 1 -->
        <div class="flex flex-col">
          <label for="endereco" class="ms-form-label">Endere√ßo</label>
          <input type="text" id="endereco" class="ms-form-input" required>
        </div>
        <div class="flex flex-col">
          <label for="numero" class="ms-form-label">N√∫mero</label>
          <input type="text" id="numero" class="ms-form-input">
        </div>
        <div class="flex flex-col">
          <label for="bairro" class="ms-form-label">Bairro</label>
          <input type="text" id="bairro" class="ms-form-input" readonly>
        </div>
        
        <!-- Coluna 2 -->
        <div class="flex flex-col">
          <label for="cidade" class="ms-form-label">Cidade</label>
          <input type="text" id="cidade" class="ms-form-input" readonly>
        </div>
        <div class="flex flex-col">
          <label for="tronco" class="ms-form-label">Tronco</label>
          <select id="tronco" class="ms-form-input">
            <option value="">Selecione...</option>
            <option value="TRONCO">TRONCO</option>
            <option value="RAMAL">RAMAL</option>
          </select>
        </div>
        <div class="flex flex-col">
          <label for="chave" class="ms-form-label">Chave</label>
          <input type="text" id="chave" class="ms-form-input">
        </div>
        
        <!-- Coluna 3 -->
        <div class="flex flex-col">
          <label for="qtd" class="ms-form-label">Quantidade</label>
          <input type="number" id="qtd" class="ms-form-input" min="0" step="1">
        </div>
        <div class="flex flex-col">
          <label for="alimentador" class="ms-form-label">Alimentador</label>
          <input type="text" id="alimentador" class="ms-form-input">
        </div>
        <div class="flex flex-col">
          <label for="data" class="ms-form-label">Data</label>
          <input type="date" id="data" class="ms-form-input">
        </div>
        
        <!-- Coluna 4 -->
        <div class="flex flex-col">
          <label for="equipe" class="ms-form-label">Equipe</label>
          <input type="text" id="equipe" class="ms-form-input">
        </div>
        <div class="flex flex-col">
          <label for="matricula" class="ms-form-label">Matr√≠cula</label>
          <input type="text" id="matricula" class="ms-form-input">
        </div>
        <div class="flex flex-col">
          <label for="ea" class="ms-form-label">EA</label>
          <input type="text" id="ea" class="ms-form-input">
        </div>
        
        <!-- Observa√ß√£o -->
        <div class="flex flex-col col-span-1 sm:col-span-2 lg:col-span-3">
          <label for="obs" class="ms-form-label">Observa√ß√£o</label>
          <textarea id="obs" class="ms-form-input h-24"></textarea>
        </div>
        
        <!-- Servi√ßos -->
        <div class="flex flex-col col-span-1 sm:col-span-2 lg:col-span-3">
          <label for="servico" class="ms-form-label">Servi√ßo (Selecione um ou mais)</label>
          <select id="servico" multiple size="6" class="ms-form-input w-full" required>
            <option value="PC">Poda prim√°ria completa - PC</option>
            <option value="PS">Poda secund√°ria completa - PS</option>
            <option value="PP">Poda prim√°ria parcial - PP</option>
            <option value="SP">Poda secund√°ria parcial - SP</option>
            <option value="U">Cruzeta urgente troca em 15 dias - U</option>
            <option value="CV">Corte de cerca viva - CV</option>
            <option value="A">Cruzeta alta para 90 dias - A</option>
          </select>
        </div>
      </form>

      <!-- Bot√µes do Formul√°rio -->
      <div class="flex flex-wrap gap-3 mb-6 justify-center">
        <button id="btnSalvar" onclick="app.form.save(event)" class="ms-button ms-button-success py-2 px-6 flex items-center">
          <span class="mr-2">üíæ</span> Salvar
        </button>
        <button onclick="app.form.clear()" class="ms-button ms-button-neutral py-2 px-6 flex items-center">
          <span class="mr-2">üßπ</span> Limpar
        </button>
      </div>

      <!-- Mensagem de Status -->
      <div id="status" class="mb-6 p-3 rounded text-white hidden"></div>
    </div>

    <!-- Tabela de Dados -->
    <div class="mt-6">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Servi√ßos Registrados</h3>
      <div class="overflow-x-auto ms-card bg-white">
        <table id="tabela" class="ms-table w-full">
          <thead>
            <tr>
              <th>Endere√ßo</th>
              <th>Bairro</th>
              <th>Qtd</th>
              <th>Data</th>
              <th>Equipe</th>
              <th>Servi√ßos</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Rodap√© com Status Autom√°tico -->
  <footer class="ms-status-bar mt-auto">
    <div class="container max-w-6xl mx-auto px-4 py-2 flex items-center justify-between">
      <div class="flex items-center">
        <div id="autoStatus" class="status-dot mr-2"></div>
        <span id="statusMessage">Conectando...</span>
      </div>
      <div class="text-sm">Sistema de Cadastro de Servi√ßos v1.0</div>
    </div>
  </footer>

  <script>
    const app = {
      BASE_URL: 'https://fonseca.onrender.com',
      
      // M√≥dulo de formul√°rio
      form: {
        editId: null,
        
        save: function(event) {
          event.preventDefault();
          const endereco = document.getElementById('endereco').value.trim();
          const servicosSelecionados = Array.from(document.getElementById('servico').selectedOptions).map(opt => opt.text);
          
          if (!endereco) {
            app.utils.showStatus('Endere√ßo √© obrigat√≥rio.', 'error');
            return;
          }
          if (!servicosSelecionados.length) {
            app.utils.showStatus('Selecione pelo menos um servi√ßo.', 'error');
            return;
          }
          
          const item = {
            id: this.editId || Date.now(),
            ...app.utils.sanitizeForm(),
            servicos: servicosSelecionados
          };
          
          // Salva campos no cache
          app.cache.saveFields();
          
          app.api.saveService(item);
        },
        
        clear: function() {
          document.getElementById('formulario').reset();
          this.editId = null;
          document.getElementById('btnSalvar').innerHTML = '<span class="mr-2">üíæ</span> Salvar';
          document.getElementById('endereco').focus();
          
          // Restaura campos do cache
          app.cache.loadFields();
        },
        
        edit: function(id) {
          const item = app.data.services.find(i => i.id === id);
          if (!item) return;
          
          this.editId = id;
          Object.keys(item).forEach(key => {
            const element = document.getElementById(key);
            if (element) {
              if (key === 'servico') {
                Array.from(element.options).forEach(opt => 
                  opt.selected = (item.servicos || '').split(', ').includes(opt.text)
                );
              } else {
                element.value = item[key] || '';
              }
            }
          });
          
          document.getElementById('btnSalvar').innerHTML = '<span class="mr-2">üîÑ</span> Atualizar';
          document.getElementById('endereco').focus();
        }
      },
      
      // M√≥dulo de cache
      cache: {
        fields: ['equipe', 'matricula', 'ea'],
        
        saveFields: function() {
          this.fields.forEach(field => {
            const value = document.getElementById(field).value.trim();
            if (value) {
              localStorage.setItem(field, value);
            }
          });
        },
        
        loadFields: function() {
          this.fields.forEach(field => {
            const savedValue = localStorage.getItem(field);
            if (savedValue) {
              document.getElementById(field).value = savedValue;
            }
          });
        }
      },
      
      // M√≥dulo de geolocaliza√ß√£o
      geolocation: {
        lastCall: 0,
        debounceDelay: 1000,
        
        getCoordinates: function() {
          if (Date.now() - this.lastCall < this.debounceDelay) {
            app.utils.showStatus('Aguarde antes de tentar novamente.', 'error');
            return;
          }
          this.lastCall = Date.now();
          
          if (!navigator.geolocation) {
            app.utils.showStatus('Geolocaliza√ß√£o n√£o suportada.', 'error');
            return;
          }
          
          navigator.geolocation.getCurrentPosition(
            pos => {
              document.getElementById('latitude').value = pos.coords.latitude.toFixed(6);
              document.getElementById('longitude').value = pos.coords.longitude.toFixed(6);
              app.utils.showStatus('Coordenadas obtidas com sucesso!', 'success');
            },
            err => app.utils.showStatus('Erro ao obter localiza√ß√£o: ' + err.message, 'error')
          );
        },
        
        getAddress: function() {
          if (Date.now() - this.lastCall < this.debounceDelay) {
            app.utils.showStatus('Aguarde antes de tentar novamente.', 'error');
            return;
          }
          this.lastCall = Date.now();
          
          if (!navigator.onLine) {
            app.utils.showStatus('Sem conex√£o. Insira manualmente.', 'error');
            return;
          }
          
          if (!navigator.geolocation) {
            app.utils.showStatus('Geolocaliza√ß√£o n√£o suportada. Insira manualmente.', 'error');
            return;
          }
          
          app.utils.showStatus('Buscando endere√ßo...', 'success');
          
          navigator.geolocation.getCurrentPosition(
            pos => {
              const lat = pos.coords.latitude;
              const lon = pos.coords.longitude;
              const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
              
              fetch(url, { headers: { 'User-Agent': 'CadastroServicos/1.0' } })
                .then(res => res.json())
                .then(data => {
                  const address = data.address || {};
                  
                  // Mapeamento melhorado para bairro
                  const bairro = address.suburb || 
                                address.neighbourhood || 
                                address.quarter || 
                                address.city_district || 
                                '';
                  
                  document.getElementById('endereco').value = address.road || address.street || '';
                  document.getElementById('numero').value = address.housenumber || '';
                  document.getElementById('bairro').value = bairro;
                  document.getElementById('cidade').value = address.city || address.town || address.village || '';
                  document.getElementById('latitude').value = lat.toFixed(6);
                  document.getElementById('longitude').value = lon.toFixed(6);
                  
                  app.utils.showStatus('Endere√ßo obtido com sucesso!', 'success');
                })
                .catch(err => {
                  app.utils.showStatus('Erro ao buscar endere√ßo: ' + err.message, 'error');
                  document.getElementById('endereco').focus();
                });
            },
            err => {
              app.utils.showStatus('Erro ao obter localiza√ß√£o: ' + err.message, 'error');
              document.getElementById('endereco').focus();
            }
          );
        }
      },
      
      // M√≥dulo de testes
      tests: {
        testBackend: async function() {
          try {
            const response = await fetch(app.BASE_URL);
            if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
            const data = await response.json();
            app.utils.showStatus('Backend conectado com sucesso! Mensagem: ' + data.message, 'success', 'statusTestes');
          } catch (err) {
            app.utils.showStatus('Erro ao conectar ao backend: ' + err.message, 'error', 'statusTestes');
          }
        },
        
        testDatabase: async function() {
          try {
            const response = await fetch(`${app.BASE_URL}/test-db`);
            if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
            const data = await response.json();
            app.utils.showStatus('Conex√£o com o banco bem-sucedida! Hor√°rio: ' + data.time, 'success', 'statusTestes');
          } catch (err) {
            app.utils.showStatus('Erro ao conectar ao banco: ' + err.message, 'error', 'statusTestes');
          }
        },
        
        testServices: async function() {
          try {
            const response = await fetch(`${app.BASE_URL}/servicos`);
            if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
            const data = await response.json();
            app.utils.showStatus(`Endpoint /servicos funcionando! ${data.length} registros encontrados.`, 'success', 'statusTestes');
          } catch (err) {
            app.utils.showStatus('Erro ao acessar /servicos: ' + err.message, 'error', 'statusTestes');
          }
        }
      },
      
      // M√≥dulo de API
      api: {
        async saveService(item) {
          try {
            const method = app.form.editId ? 'PUT' : 'POST';
            const url = app.form.editId ? `${app.BASE_URL}/servicos/${app.form.editId}` : `${app.BASE_URL}/servicos`;
            const response = await fetch(url, {
              method,
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(item)
            });
            
            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(errorData.error || `Erro HTTP: ${response.status}`);
            }
            
            await app.data.load();
            app.form.clear();
            app.utils.showStatus(app.form.editId ? 'Registro atualizado!' : 'Registro salvo!', 'success');
            app.form.editId = null;
          } catch (err) {
            app.utils.showStatus(`Erro ao ${app.form.editId ? 'atualizar' : 'salvar'}: ${err.message}`, 'error');
          }
        },
        
        async deleteService(id) {
          if (!confirm('Deseja realmente excluir?')) return;
          try {
            const response = await fetch(`${app.BASE_URL}/servicos/${id}`, { method: 'DELETE' });
            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(errorData.error || `Erro HTTP: ${response.status}`);
            }
            await app.data.load();
            app.utils.showStatus('Registro exclu√≠do!', 'success');
          } catch (err) {
            app.utils.showStatus(`Erro ao excluir: ${err.message}`, 'error');
          }
        },
        
        async autoTestConnection() {
          try {
            const response = await fetch(`${app.BASE_URL}/test-db`);
            if (response.ok) {
              const data = await response.json();
              document.getElementById('autoStatus').className = 'status-dot status-green';
              document.getElementById('statusMessage').textContent = `Conectado - ${data.time}`;
            }
          } catch {
            document.getElementById('autoStatus').className = 'status-dot status-red';
            document.getElementById('statusMessage').textContent = 'Conex√£o falhou';
          }
        }
      },
      
      // M√≥dulo de dados
      data: {
        services: [],
        
        async load() {
          try {
            const response = await fetch(`${app.BASE_URL}/servicos`);
            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(errorData.error || `Erro HTTP: ${response.status}`);
            }
            this.services = await response.json();
            this.renderTable();
          } catch (err) {
            app.utils.showStatus(`Erro ao carregar dados: ${err.message}`, 'error');
          }
        },
        
        renderTable() {
          const tbody = document.querySelector('#tabela tbody');
          tbody.innerHTML = '';
          
          this.services.forEach(item => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50 transition-colors';
            
            tr.innerHTML = `
              <td class="p-3">${item.endereco || ''} ${item.numero || ''}</td>
              <td class="p-3">${item.bairro || ''}</td>
              <td class="p-3">${item.qtd || ''}</td>
              <td class="p-3">${item.data || ''}</td>
              <td class="p-3">${item.equipe || ''}</td>
              <td class="p-3">${item.servicos || ''}</td>
              <td class="p-3 flex gap-2">
                <button onclick="app.form.edit(${item.id})" class="text-blue-600 hover:text-blue-800" aria-label="Editar">
                  ‚úèÔ∏è
                </button>
                <button onclick="app.api.deleteService(${item.id})" class="text-red-600 hover:text-red-800" aria-label="Excluir">
                  üóëÔ∏è
                </button>
              </td>
            `;
            
            tbody.appendChild(tr);
          });
        }
      },
      
      // Utilit√°rios
      utils: {
        sanitizeInput(input) {
          if (typeof input !== 'string') return input;
          return input.replace(/</g, "&lt;").replace(/>/g, "&gt;");
        },
        
        sanitizeForm() {
          const fields = [
            'endereco', 'numero', 'bairro', 'cidade', 'tronco', 'chave',
            'qtd', 'alimentador', 'obs', 'data', 'equipe', 'matricula', 'ea',
            'latitude', 'longitude'
          ];
          
          const result = {};
          fields.forEach(field => {
            const element = document.getElementById(field);
            const value = element ? element.value.trim() : '';
            result[field] = this.sanitizeInput(value);
          });
          return result;
        },
        
        showStatus(message, type, target = 'status') {
          const element = document.getElementById(target);
          element.textContent = message;
          element.className = `p-3 rounded fade-in ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
          element.classList.remove('hidden');
          
          setTimeout(() => {
            element.classList.add('hidden');
          }, 5000);
        }
      },
      
      // Inicializa√ß√£o
      init: function() {
        this.data.load();
        this.api.autoTestConnection();
        setInterval(() => this.api.autoTestConnection(), 60000);
        
        // Carregar cache ao iniciar
        app.cache.loadFields();
      }
    };

    // Inicializar a aplica√ß√£o quando o documento estiver carregado
    document.addEventListener('DOMContentLoaded', () => {
      app.init();
    });
  </script>
</body>
</html>
