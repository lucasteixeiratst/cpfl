<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Sensor</title>
    <style>
        body { background: #000; color: #0f0; font-family: monospace; padding: 20px; font-size: 1.2rem; }
        .error { color: #f00; border: 1px solid #f00; padding: 10px; margin-top: 10px; }
        .success { color: #0f0; border: 1px solid #0f0; padding: 10px; margin-top: 10px; }
        button { padding: 15px; font-size: 1rem; width: 100%; margin-bottom: 20px; }
    </style>
</head>
<body>

    <h1>DIAGNÓSTICO DE SENSOR</h1>
    <button onclick="startTest()">INICIAR TESTE</button>

    <div id="log">Aguardando...</div>

<script>
    const logDiv = document.getElementById('log');

    function log(msg, type='normal') {
        const div = document.createElement('div');
        div.innerText = "> " + msg;
        if(type==='err') div.className = 'error';
        if(type==='ok') div.className = 'success';
        logDiv.appendChild(div);
    }

    async function startTest() {
        logDiv.innerHTML = "";
        log("Iniciando testes...");

        // 1. Checa HTTPS
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            log("ERRO CRÍTICO: Você não está usando HTTPS nem Localhost.", 'err');
            log("O Chrome bloqueia sensores em " + location.protocol, 'err');
            return;
        } else {
            log("Conexão Segura (HTTPS/Local): OK", 'ok');
        }

        // 2. Checa Suporte do Navegador
        if (!('Magnetometer' in window)) {
            log("ERRO: Seu navegador não conhece a API 'Magnetometer'.", 'err');
            log("Tente ativar a flag: chrome://flags/#enable-generic-sensor-extra-classes", 'err');
            
            // Tenta fallback antigo
            log("Tentando método antigo (DeviceOrientation)...");
            window.addEventListener('deviceorientation', (e) => {
                if(e.alpha) log(`Método Antigo Funcionando! Alpha: ${e.alpha.toFixed(0)}`, 'ok');
            });
            return;
        } else {
            log("API Magnetometer detectada no navegador.", 'ok');
        }

        // 3. Tenta Ler Permissões
        try {
            const result = await navigator.permissions.query({ name: 'magnetometer' });
            log("Status da Permissão: " + result.state);
            if (result.state === 'denied') {
                log("ERRO: Permissão negada pelo usuário. Limpe os dados do site e tente de novo.", 'err');
                return;
            }
        } catch (error) {
            log("Não foi possível checar permissão (comum em alguns Androids). Ignorando...");
        }

        // 4. Tenta Ligar o Sensor
        try {
            const mag = new Magnetometer({ frequency: 60 });
            
            mag.addEventListener('error', event => {
                log("ERRO NO SENSOR: " + event.error.name, 'err');
                log("Mensagem: " + event.error.message, 'err');
            });

            mag.addEventListener('reading', () => {
                log(`SUCESSO! Leitura: ${mag.x.toFixed(2)}`, 'ok');
                mag.stop(); // Para após ler
            });

            mag.start();
            log("Solicitando sensor... aguarde...");
        } catch (error) {
            log("Erro fatal ao iniciar: " + error, 'err');
        }
    }
</script>
</body>
</html>