<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Consolidador de KMZ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        button {
            background-color: #4285F4;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #357ae8;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #progress {
            margin-top: 20px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
            display: none;
        }
        #fileList {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        .file-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        #status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #e6f4ea;
            color: #0d652d;
        }
        .error {
            background-color: #fce8e6;
            color: #c5221f;
        }
        #downloadBtn {
            display: none;
            margin-top: 20px;
            background-color: #0d652d;
        }
        #downloadBtn:hover {
            background-color: #0b5a29;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Consolidador de Arquivos KMZ</h1>
        
        <div class="controls">
            <button id="loadBtn">Carregar Arquivos KMZ</button>
            <button id="consolidateBtn" disabled>Consolidar Dados</button>
            <button id="downloadBtn">Download GeoJSON</button>
        </div>
        
        <div id="progress" style="display: none;">
            <h3>Progresso:</h3>
            <div id="progressBar"></div>
        </div>
        
        <div id="fileList"></div>
        
        <div id="status"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://unpkg.com/@tmcw/togeojson/dist/togeojson.js"></script>
    <script>
        // Estado da aplicação
        const state = {
            kmzFiles: [],
            consolidatedData: null
        };

        // Elementos do DOM
        const loadBtn = document.getElementById('loadBtn');
        const consolidateBtn = document.getElementById('consolidateBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const progressDiv = document.getElementById('progress');
        const progressBar = document.getElementById('progressBar');
        const fileListDiv = document.getElementById('fileList');
        const statusDiv = document.getElementById('status');

        // Lista completa dos 116 arquivos KMZ
        const kmzFiles = [
            { name: 'AGUAS DE LINDOIA.kmz', url: 'AGUAS DE LINDOIA.kmz' },
            { name: 'AGUDOS.kmz', url: 'AGUDOS.kmz' },
            { name: 'ALTINOPOLIS.kmz', url: 'ALTINOPOLIS.kmz' },
            { name: 'AMERICANA.kmz', url: 'AMERICANA.kmz' },
            { name: 'AMPARO.kmz', url: 'AMPARO.kmz' },
            { name: 'ARACATUBA.kmz', url: 'ARACATUBA.kmz' },
            { name: 'ARARAQUARA.kmz', url: 'ARARAQUARA.kmz' },
            { name: 'BARIRI.kmz', url: 'BARIRI.kmz' },
            { name: 'BARRA BONITA.kmz', url: 'BARRA BONITA.kmz' },
            { name: 'BARRETOS.kmz', url: 'BARRETOS.kmz' },
            { name: 'BATATAIS.kmz', url: 'BATATAIS.kmz' },
            { name: 'BAURU.kmz', url: 'BAURU.kmz' },
            { name: 'BEBEDOURO.kmz', url: 'BEBEDOURO.kmz' },
            { name: 'BIRIGUI.kmz', url: 'BIRIGUI.kmz' },
            { name: 'BOA ESPERANCA DO SUL.kmz', url: 'BOA ESPERANCA DO SUL.kmz' },
            { name: 'BOTUCATU.kmz', url: 'BOTUCATU.kmz' },
            { name: 'BRAUNA.kmz', url: 'BRAUNA.kmz' },
            { name: 'BROTAS.kmz', url: 'BROTAS.kmz' },
            { name: 'CAFELANDIA.kmz', url: 'CAFELANDIA.kmz' },
            { name: 'CAJOBI.kmz', url: 'CAJOBI.kmz' },
            { name: 'CAJURU.kmz', url: 'CAJURU.kmz' },
            { name: 'CAMPINAS BARAO GERALDO-1.kmz', url: 'CAMPINAS BARAO GERALDO-1.kmz' },
            { name: 'CAMPINAS CAMPO GRANDE-1.kmz', url: 'CAMPINAS CAMPO GRANDE-1.kmz' },
            { name: 'CAMPINAS CENTRO-1.kmz', url: 'CAMPINAS CENTRO-1.kmz' },
            { name: 'CAMPINAS SOUZAS-1.kmz', url: 'CAMPINAS SOUZAS-1.kmz' },
            { name: 'CAMPINAS TREVO-1.kmz', url: 'CAMPINAS TREVO-1.kmz' },
            { name: 'CAPIVARI.kmz', url: 'CAPIVARI.kmz' },
            { name: 'CONGONHAS.kmz', url: 'CONGONHAS.kmz' },
            { name: 'COSMOPOLIS.kmz', url: 'COSMOPOLIS.kmz' },
            { name: 'CRAVINHOS.kmz', url: 'CRAVINHOS.kmz' },
            { name: 'DESCALVADO.kmz', url: 'DESCALVADO.kmz' },
            { name: 'DOIS CORREGOS.kmz', url: 'DOIS CORREGOS.kmz' },
            { name: 'DOURADO.kmz', url: 'DOURADO.kmz' },
            { name: 'DUARTINA.kmz', url: 'DUARTINA.kmz' },
            { name: 'ESPIRITO SANTO DO PINHAL.kmz', url: 'ESPIRITO SANTO DO PINHAL.kmz' },
            { name: 'FRANCA.kmz', url: 'FRANCA.kmz' },
            { name: 'GARCA.kmz', url: 'GARCA.kmz' },
            { name: 'GAVIAO PEIXOTO.kmz', url: 'GAVIAO PEIXOTO.kmz' },
            { name: 'GETULINA.kmz', url: 'GETULINA.kmz' },
            { name: 'GUAIRA.kmz', url: 'GUAIRA.kmz' },
            { name: 'GUANABARA.kmz', url: 'GUANABARA.kmz' },
            { name: 'GUARARAPES.kmz', url: 'GUARARAPES.kmz' },
            { name: 'GUARIBA.kmz', url: 'GUARIBA.kmz' },
            { name: 'HIPODROMO.kmz', url: 'HIPODROMO.kmz' },
            { name: 'HORTOLANDIA.kmz', url: 'HORTOLANDIA.kmz' },
            { name: 'IACANGA.kmz', url: 'IACANGA.kmz' },
            { name: 'IBIRA.kmz', url: 'IBIRA.kmz' },
            { name: 'IBITINGA.kmz', url: 'IBITINGA.kmz' },
            { name: 'IGARAPAVA.kmz', url: 'IGARAPAVA.kmz' },
            { name: 'IPUA.kmz', url: 'IPUA.kmz' },
            { name: 'ITAPIRA.kmz', url: 'ITAPIRA.kmz' },
            { name: 'ITAPOLIS.kmz', url: 'ITAPOLIS.kmz' },
            { name: 'ITATIBA.kmz', url: 'ITATIBA.kmz' },
            { name: 'ITATINGA.kmz', url: 'ITATINGA.kmz' },
            { name: 'ITUVERAVA.kmz', url: 'ITUVERAVA.kmz' },
            { name: 'JABOTICABAL.kmz', url: 'JABOTICABAL.kmz' },
            { name: 'JARDINOPOLIS.kmz', url: 'JARDINOPOLIS.kmz' },
            { name: 'JAU.kmz', url: 'JAU.kmz' },
            { name: 'JOSE BONIFACIO.kmz', url: 'JOSE BONIFACIO.kmz' },
            { name: 'LENCOIS PAULISTA.kmz', url: 'LENCOIS PAULISTA.kmz' },
            { name: 'LINS.kmz', url: 'LINS.kmz' },
            { name: 'MARILIA.kmz', url: 'MARILIA.kmz' },
            { name: 'MATAO.kmz', url: 'MATAO.kmz' },
            { name: 'METROPOLITANA.kmz', url: 'METROPOLITANA.kmz' },
            { name: 'MIGUELOPOLIS.kmz', url: 'MIGUELOPOLIS.kmz' },
            { name: 'MIRASSOL.kmz', url: 'MIRASSOL.kmz' },
            { name: 'MONTE ALTO.kmz', url: 'MONTE ALTO.kmz' },
            { name: 'MONTE APRAZIVEL.kmz', url: 'MONTE APRAZIVEL.kmz' },
            { name: 'MONTE MOR.kmz', url: 'MONTE MOR.kmz' },
            { name: 'MORRO AGUDO.kmz', url: 'MORRO AGUDO.kmz' },
            { name: 'MORRO DO CIPO.kmz', url: 'MORRO DO CIPO.kmz' },
            { name: 'NOVA GRANDA.kmz', url: 'NOVA GRANDA.kmz' },
            { name: 'OCAUCU.kmz', url: 'OCAUCU.kmz' },
            { name: 'OLIMPIA.kmz', url: 'OLIMPIA.kmz' },
            { name: 'ORLANDIA.kmz', url: 'ORLANDIA.kmz' },
            { name: 'PARAISO.kmz', url: 'PARAISO.kmz' },
            { name: 'PARDINHO.kmz', url: 'PARDINHO.kmz' },
            { name: 'PAULINIA.kmz', url: 'PAULINIA.kmz' },
            { name: 'PEDERNEIRAS.kmz', url: 'PEDERNEIRAS.kmz' },
            { name: 'PEDREGULHO.kmz', url: 'PEDREGULHO.kmz' },
            { name: 'PENAPOLIS.kmz', url: 'PENAPOLIS.kmz' },
            { name: 'PIACATU.kmz', url: 'PIACATU.kmz' },
            { name: 'PIRACICABA SANTA CECILIA.kmz', url: 'PIRACICABA SANTA CECILIA.kmz' },
            { name: 'PIRACICABA SANTA TEREZINHA.kmz', url: 'PIRACICABA SANTA TEREZINHA.kmz' },
            { name: 'PIRACICABA.kmz', url: 'PIRACICABA.kmz' },
            { name: 'PIRAJUI - EA.kmz', url: 'PIRAJUI - EA.kmz' },
            { name: 'PIRANGI.kmz', url: 'PIRANGI.kmz' },
            { name: 'PITANGUEIRAS.kmz', url: 'PITANGUEIRAS.kmz' },
            { name: 'POMPEIA.kmz', url: 'POMPEIA.kmz' },
            { name: 'PRESIDENTE ALVES.kmz', url: 'PRESIDENTE ALVES.kmz' },
            { name: 'PROMISSAO.kmz', url: 'PROMISSAO.kmz' },
            { name: 'RESTINGA.kmz', url: 'RESTINGA.kmz' },
            { name: 'RIBEIRAO PRETO NORTE.kmz', url: 'RIBEIRAO PRETO NORTE.kmz' },
            { name: 'RIBEIRAO PRETO SUL.kmz', url: 'RIBEIRAO PRETO SUL.kmz' },
            { name: 'RINCAO.kmz', url: 'RINCAO.kmz' },
            { name: 'SANTA ADELIA.kmz', url: 'SANTA ADELIA.kmz' },
            { name: 'SANTA BARBARA DOESTE.kmz', url: 'SANTA BARBARA DOESTE.kmz' },
            { name: 'SANTA ROSA DE VITERBO.kmz', url: 'SANTA ROSA DE VITERBO.kmz' },
            { name: 'SANTO ANTONIO ARACANGUA.kmz', url: 'SANTO ANTONIO ARACANGUA.kmz' },
            { name: 'SAO CARLOS.kmz', url: 'SAO CARLOS.kmz' },
            { name: 'SAO JOAQUIM DA BARRA.kmz', url: 'SAO JOAQUIM DA BARRA.kmz' },
            { name: 'SAO JOSE RIO PRETO.kmz', url: 'SAO JOSE RIO PRETO.kmz' },
            { name: 'SAO MANUEL.kmz', url: 'SAO MANUEL.kmz' },
            { name: 'SAO PEDRO.kmz', url: 'SAO PEDRO.kmz' },
            { name: 'SAO SIMAO.kmz', url: 'SAO SIMAO.kmz' },
            { name: 'SERRA NEGRA.kmz', url: 'SERRA NEGRA.kmz' },
            { name: 'SERRANA.kmz', url: 'SERRANA.kmz' },
            { name: 'SERTAOZINHO.kmz', url: 'SERTAOZINHO.kmz' },
            { name: 'SOCORRO.kmz', url: 'SOCORRO.kmz' },
            { name: 'SUMARE.kmz', url: 'SUMARE.kmz' },
            { name: 'TANABI.kmz', url: 'TANABI.kmz' },
            { name: 'TAQUARITINGA.kmz', url: 'TAQUARITINGA.kmz' },
            { name: 'UIRAPURU.kmz', url: 'UIRAPURU.kmz' },
            { name: 'VALINHOS.kmz', url: 'VALINHOS.kmz' },
            { name: 'VALPARAISO.kmz', url: 'VALPARAISO.kmz' },
            { name: 'VIRADOURO.kmz', url: 'VIRADOURO.kmz' }
        ];

        // Carrega a lista de arquivos KMZ
        loadBtn.addEventListener('click', () => {
            state.kmzFiles = [...kmzFiles];
            updateFileList();
            consolidateBtn.disabled = false;
            showStatus('Lista de 116 arquivos KMZ carregada com sucesso!', 'success');
        });

        // Consolida os dados de todos os arquivos KMZ
        consolidateBtn.addEventListener('click', async () => {
            try {
                progressDiv.style.display = 'block';
                progressBar.innerHTML = 'Preparando...';
                
                const result = await processAllKMZFiles();
                state.consolidatedData = result;
                
                showStatus('Dados dos 116 arquivos consolidados com sucesso!', 'success');
                downloadBtn.style.display = 'block';
            } catch (error) {
                console.error('Erro ao consolidar dados:', error);
                showStatus(`Erro ao consolidar dados: ${error.message}`, 'error');
            } finally {
                progressDiv.style.display = 'none';
            }
        });

        // Download do GeoJSON consolidado
        downloadBtn.addEventListener('click', () => {
            if (!state.consolidatedData) return;
            
            const dataStr = JSON.stringify(state.consolidatedData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dados_consolidados_116_arquivos.geojson';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Atualiza a lista de arquivos na interface
        function updateFileList() {
            fileListDiv.innerHTML = '';
            state.kmzFiles.forEach(file => {
                const div = document.createElement('div');
                div.className = 'file-item';
                div.textContent = file.name;
                fileListDiv.appendChild(div);
            });
        }

        // Mostra mensagens de status
        function showStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = type;
        }

        // Processa todos os arquivos KMZ
        async function processAllKMZFiles() {
            const consolidatedGeoJSON = {
                type: 'FeatureCollection',
                features: []
            };
            
            for (let i = 0; i < state.kmzFiles.length; i++) {
                const file = state.kmzFiles[i];
                const progress = Math.floor((i / state.kmzFiles.length) * 100);
                progressBar.innerHTML = `Processando ${i+1}/116: ${file.name}... (${progress}%)`;
                
                try {
                    const response = await fetch(file.url);
                    if (!response.ok) {
                        throw new Error(`Falha ao carregar ${file.name}: ${response.status}`);
                    }
                    
                    let geoJSON;
                    if (file.name.endsWith('.kmz')) {
                        const arrayBuffer = await response.arrayBuffer();
                        geoJSON = await parseKMZ(arrayBuffer);
                    } else {
                        const text = await response.text();
                        const kml = new DOMParser().parseFromString(text, 'text/xml');
                        geoJSON = toGeoJSON.kml(kml);
                    }
                    
                    // Adiciona metadados do arquivo de origem
                    geoJSON.features.forEach(feature => {
                        feature.properties = feature.properties || {};
                        feature.properties.sourceFile = file.name;
                        consolidatedGeoJSON.features.push(feature);
                    });
                    
                } catch (error) {
                    console.error(`Erro ao processar ${file.name}:`, error);
                    // Continua para o próximo arquivo mesmo se um falhar
                }
                
                // Pequeno delay para não sobrecarregar o navegador
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            return consolidatedGeoJSON;
        }

        // Converte KMZ para GeoJSON
        async function parseKMZ(arrayBuffer) {
            const zip = await JSZip.loadAsync(arrayBuffer);
            const kmlFile = zip.file(/\.kml$/i)[0];
            if (!kmlFile) {
                throw new Error('Arquivo KML não encontrado no KMZ');
            }
            const kmlContent = await kmlFile.async('text');
            const kml = new DOMParser().parseFromString(kmlContent, 'text/xml');
            return toGeoJSON.kml(kml);
        }
    </script>
</body>
</html>